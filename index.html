<!-- index.html â€” "Ğ¡Ğ¢ĞĞ Ğ˜ĞšĞĞœ Ğ¢Ğ£Ğ¢ ĞĞ• ĞœĞ•Ğ¡Ğ¢Ğ!" â€” Ğ ÑƒÑÑĞºĞ¸Ğµ ÑˆĞ°ÑˆĞºĞ¸ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ (PeerJS WebRTC) -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ğ¡Ğ¢ĞĞ Ğ˜ĞšĞĞœ Ğ¢Ğ£Ğ¢ ĞĞ• ĞœĞ•Ğ¡Ğ¢Ğ!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• Ğ¡Ğ¢Ğ˜Ğ›Ğ˜ â€” Ğ¢ĞĞœĞĞĞ¯ Ğ¢Ğ•ĞœĞ ĞœĞ˜ĞĞ˜ĞœĞĞ›Ğ˜Ğ—Ğœ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg: #0a0a0a;
  --panel: #111111;
  --border: #222;
  --accent: #e63946;
  --text: #f1faee;
  --text2: #a8a8a8;
  --cell-dark: #1a1a2e;
  --cell-light: #16213e;
  --p1: #e63946;
  --p2: #f1faee;
  --hl-move: rgba(230,57,70,0.3);
  --hl-sel: rgba(230,57,70,0.6);
  --font: 'JetBrains Mono', monospace;
}

html, body {
  width:100%; min-height:100vh;
  background: var(--bg); color: var(--text);
  font-family: var(--font); font-size:14px;
  overflow-x:hidden;
}

/* Ğ¡ĞºÑ€Ğ¾Ğ»Ğ»Ğ±Ğ°Ñ€ */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--accent); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app {
  display:flex; flex-direction:column; align-items:center;
  min-height:100vh; padding:16px;
}

h1.title {
  font-size: clamp(18px, 5vw, 36px);
  font-weight:900; text-transform:uppercase;
  letter-spacing:6px; color:var(--accent);
  text-align:center; margin:16px 0 8px;
  text-shadow: 0 0 30px rgba(230,57,70,0.3);
  user-select:none;
}

.subtitle {
  color:var(--text2); font-size:12px; margin-bottom:20px;
  letter-spacing:2px; text-transform:uppercase;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ĞŸĞĞĞ•Ğ›Ğ˜ / ĞšĞĞ Ğ¢ĞĞ§ĞšĞ˜
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel {
  background:var(--panel); border:1px solid var(--border);
  padding:24px; width:100%; max-width:500px; margin-bottom:16px;
}

.panel-title {
  font-size:13px; font-weight:700; color:var(--accent);
  letter-spacing:3px; text-transform:uppercase; margin-bottom:16px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ĞšĞĞĞŸĞšĞ˜
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display:inline-block; padding:12px 24px;
  background:transparent; color:var(--accent);
  border:1px solid var(--accent); border-radius:0;
  font-family:var(--font); font-size:13px; font-weight:700;
  letter-spacing:2px; text-transform:uppercase;
  cursor:pointer; transition:all 0.2s; user-select:none;
}
.btn:hover, .btn.active { background:var(--accent); color:var(--bg); }
.btn:disabled { opacity:0.3; cursor:default; }
.btn:disabled:hover { background:transparent; color:var(--accent); }
.btn-sm { padding:8px 16px; font-size:11px; }
.btn-block { display:block; width:100%; text-align:center; }
.btn + .btn { margin-left:8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ˜ĞĞŸĞ£Ğ¢Ğ«
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.input {
  background:var(--bg); border:1px solid var(--border); color:var(--text);
  font-family:var(--font); font-size:14px; padding:12px 16px;
  border-radius:0; outline:none; width:100%; transition:border-color 0.2s;
}
.input:focus { border-color:var(--accent); }
.input::placeholder { color:var(--text2); }
.input-group { display:flex; gap:8px; margin-bottom:12px; }
.input-group .input { flex:1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ˜ĞĞ”Ğ˜ĞšĞĞ¢ĞĞ 
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.status-dot {
  display:inline-block; width:8px; height:8px; border-radius:50%;
  background:#e63946; margin-right:8px; vertical-align:middle;
  transition:background 0.3s;
}
.status-dot.online { background:#2ecc71; }
.status-line {
  font-size:11px; color:var(--text2); margin-top:12px;
  display:flex; align-items:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ­ĞšĞ ĞĞ ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ¯
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.room-code {
  font-size: clamp(32px,10vw,56px); font-weight:900;
  letter-spacing:12px; color:var(--accent); text-align:center;
  padding:24px 0; cursor:pointer; user-select:all;
  transition:text-shadow 0.3s;
}
.room-code:hover { text-shadow:0 0 20px rgba(230,57,70,0.6); }

.waiting-dots::after {
  content:''; animation: dots 1.5s steps(4,end) infinite;
}
@keyframes dots {
  0%   { content:''; }
  25%  { content:'.'; }
  50%  { content:'..'; }
  75%  { content:'...'; }
  100% { content:''; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ”ĞĞ¡ĞšĞ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.game-container {
  display:flex; flex-direction:column; align-items:center;
  width:100%; max-width:540px;
}

.player-bar {
  display:flex; align-items:center; justify-content:space-between;
  width:100%; max-width:500px; padding:8px 4px;
  font-size:12px; letter-spacing:1px; text-transform:uppercase;
}
.player-bar .name {
  display:flex; align-items:center; gap:8px;
}
.player-bar .color-dot {
  width:14px; height:14px; border-radius:50%;
  border:2px solid var(--border);
}
.player-bar.active-turn { color:var(--accent); }
.player-bar.active-turn .color-dot { border-color:var(--accent); box-shadow:0 0 8px var(--accent); }
.player-bar .captured { color:var(--text2); font-size:11px; }

.board-wrapper {
  position:relative; width:100%; max-width:500px;
  aspect-ratio:1/1;
  box-shadow: 0 0 40px rgba(230,57,70,0.1), 0 0 80px rgba(230,57,70,0.05);
  border:2px solid var(--border);
}

.board {
  display:grid; grid-template-columns:repeat(8,1fr); grid-template-rows:repeat(8,1fr);
  width:100%; height:100%;
}

.cell {
  position:relative; display:flex; align-items:center; justify-content:center;
  cursor:default; transition:background 0.2s;
}
.cell.light { background:var(--cell-light); }
.cell.dark { background:var(--cell-dark); }
.cell.highlight { background:var(--hl-move); cursor:pointer; }
.cell.highlight::after {
  content:''; position:absolute; width:30%; height:30%; border-radius:50%;
  background:var(--accent); opacity:0.5;
}
.cell.selected { background:var(--hl-sel); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ¨ĞĞ¨ĞšĞ˜
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.piece {
  width:75%; height:75%; border-radius:50%;
  position:absolute; z-index:2;
  transition: all 0.3s ease;
  cursor:pointer; user-select:none;
  display:flex; align-items:center; justify-content:center;
}
.piece.p1 {
  background: radial-gradient(circle at 35% 35%, #ff5c6a, #e63946 60%, #b02a33);
  border:2px solid #ff8a94;
  box-shadow: 0 3px 10px rgba(230,57,70,0.5), inset 0 -2px 4px rgba(0,0,0,0.3);
}
.piece.p2 {
  background: radial-gradient(circle at 35% 35%, #ffffff, #f1faee 60%, #c8d6c5);
  border:2px solid #ffffff;
  box-shadow: 0 3px 10px rgba(241,250,238,0.3), inset 0 -2px 4px rgba(0,0,0,0.15);
}
.piece.king::after {
  content:''; width:50%; height:50%; border-radius:50%;
  border:2px solid rgba(0,0,0,0.3);
  box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
}
.piece.p1.king::after { border-color:rgba(255,255,255,0.4); box-shadow:inset 0 0 6px rgba(255,255,255,0.2); }
.piece.p2.king::after { border-color:rgba(0,0,0,0.25); }

.piece.selected {
  animation: pulse 0.8s ease-in-out infinite alternate;
  z-index:10;
}
@keyframes pulse {
  from { transform:scale(1); box-shadow: 0 3px 10px rgba(230,57,70,0.5); }
  to   { transform:scale(1.1); box-shadow: 0 0 20px rgba(230,57,70,0.8); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ˜Ğ“Ğ ĞĞ’Ğ«Ğ• ĞšĞĞĞŸĞšĞ˜ ĞŸĞĞ” Ğ”ĞĞ¡ĞšĞĞ™
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.game-controls {
  display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;
  justify-content:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ›ĞĞ“ Ğ¥ĞĞ”ĞĞ’
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.move-log {
  width:100%; max-width:500px; margin-top:12px;
  max-height:120px; overflow-y:auto;
  background:var(--panel); border:1px solid var(--border);
  padding:8px 12px; font-size:11px; color:var(--text2);
}
.move-log div { padding:2px 0; border-bottom:1px solid #1a1a1a; }
.move-log div:last-child { border-bottom:none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-overlay {
  position:fixed; top:0; left:0; right:0; bottom:0; z-index:100;
  background:rgba(10,10,10,0.92); display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

.result-text {
  font-size:clamp(28px,8vw,56px); font-weight:900;
  letter-spacing:8px; text-transform:uppercase;
  animation: blink 1s ease-in-out 3;
}
@keyframes blink {
  0%,100% { opacity:1; }
  50% { opacity:0.3; }
}
.result-text.win { color:var(--accent); }
.result-text.lose { color:var(--text2); }
.result-text.draw { color:#f4a261; }
.result-buttons { margin-top:32px; display:flex; gap:12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ĞœĞĞ”ĞĞ›Ğ¬ĞĞ«Ğ• ĞĞšĞĞ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position:fixed; top:0; left:0; right:0; bottom:0; z-index:90;
  background:rgba(10,10,10,0.8); display:flex;
  align-items:center; justify-content:center;
}
.modal {
  background:var(--panel); border:1px solid var(--accent);
  padding:32px; max-width:400px; width:90%; text-align:center;
}
.modal p { margin-bottom:20px; font-size:14px; line-height:1.6; }
.modal .btn + .btn { margin-left:8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ—Ğ’Ğ£Ğš-ĞšĞĞĞŸĞšĞ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sound-toggle {
  position:fixed; top:12px; right:12px; z-index:50;
  background:transparent; border:1px solid var(--border);
  color:var(--text2); font-size:20px; width:40px; height:40px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all 0.2s; border-radius:0; font-family:var(--font);
}
.sound-toggle:hover { border-color:var(--accent); color:var(--accent); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats {
  font-size:11px; color:var(--text2); letter-spacing:1px;
  text-align:center; margin-top:8px;
}
.stats span { color:var(--accent); font-weight:700; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ĞŸĞ˜ĞĞ“
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ping-display {
  font-size:10px; color:var(--text2); position:fixed; bottom:8px; right:12px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ğ¢ĞĞ™ĞœĞ•Ğ 
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer {
  font-size:18px; font-weight:700; color:var(--text);
  min-width:60px; text-align:center;
}
.timer.urgent { color:var(--accent); animation: blink 0.5s ease-in-out infinite; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ¯
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position:fixed; top:16px; left:50%; transform:translateX(-50%);
  background:var(--accent); color:var(--bg); padding:10px 24px;
  font-size:12px; font-weight:700; letter-spacing:1px; z-index:200;
  animation: slideDown 0.3s ease, fadeOut 0.3s ease 2.7s;
  opacity:1;
}
@keyframes slideDown { from{top:-40px;opacity:0;} to{top:16px;opacity:1;} }
@keyframes fadeOut { from{opacity:1;} to{opacity:0;} }

/* ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ */
@media(max-width:520px){
  .board-wrapper { max-width:95vw; }
  .player-bar { max-width:95vw; }
  .panel { max-width:95vw; }
  h1.title { letter-spacing:3px; }
  .room-code { letter-spacing:8px; }
}
</style>
</head>
<body>

<button class="sound-toggle" id="soundBtn" title="Ğ—Ğ²ÑƒĞº">ğŸ”Š</button>
<div id="pingDisplay" class="ping-display"></div>

<div id="app">
  <h1 class="title">Ğ¡Ğ¢ĞĞ Ğ˜ĞšĞĞœ Ğ¢Ğ£Ğ¢ ĞĞ• ĞœĞ•Ğ¡Ğ¢Ğ!</h1>
  <div class="subtitle">Ğ ÑƒÑÑĞºĞ¸Ğµ ÑˆĞ°ÑˆĞºĞ¸ â€¢ ĞĞ½Ğ»Ğ°Ğ¹Ğ½</div>

  <!-- â•â•â•â•â•â•â• Ğ­ĞšĞ ĞĞ: Ğ›ĞĞ‘Ğ‘Ğ˜ â•â•â•â•â•â•â• -->
  <div id="screenLobby">
    <div class="panel">
      <div class="panel-title">ĞĞ½Ğ»Ğ°Ğ¹Ğ½ Ğ¸Ğ³Ñ€Ğ°</div>
      <button class="btn btn-block" id="btnCreate" style="margin-bottom:16px;">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñƒ</button>
      <div class="input-group">
        <input class="input" id="inputCode" placeholder="ĞšĞ¾Ğ´ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹" maxlength="6" style="text-transform:uppercase;">
        <button class="btn" id="btnJoin">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
      </div>
      <div class="status-line">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ...</span>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°</div>
      <button class="btn btn-block" id="btnLocal">2 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ·Ğ° Ğ¾Ğ´Ğ½Ğ¸Ğ¼ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾Ğ¼</button>
    </div>

    <!-- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ PeerJS ÑĞµÑ€Ğ²ĞµÑ€Ğ° (fallback) -->
    <div class="panel" style="border-color:#1a1a1a;">
      <details>
        <summary style="cursor:pointer; font-size:11px; color:var(--text2); letter-spacing:1px; text-transform:uppercase;">
          âš™ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
        </summary>
        <div style="margin-top:12px;">
          <div class="input-group">
            <input class="input" id="inputHost" placeholder="Ğ¥Ğ¾ÑÑ‚ (0.peerjs.com)" style="font-size:12px;">
          </div>
          <div class="input-group">
            <input class="input" id="inputPort" placeholder="ĞŸĞ¾Ñ€Ñ‚ (443)" type="number" style="font-size:12px;">
          </div>
          <div class="input-group">
            <input class="input" id="inputPath" placeholder="ĞŸÑƒÑ‚ÑŒ (/)" style="font-size:12px;">
          </div>
          <button class="btn btn-sm btn-block" id="btnReconnect">ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ</button>
        </div>
      </details>
    </div>

    <div class="stats" id="statsDisplay"></div>
  </div>

  <!-- â•â•â•â•â•â•â• Ğ­ĞšĞ ĞĞ: ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ• â•â•â•â•â•â•â• -->
  <div id="screenWaiting" style="display:none;">
    <div class="panel" style="text-align:center;">
      <div class="panel-title">ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°</div>
      <div class="room-code" id="roomCodeDisplay" title="ĞĞ°Ğ¶Ğ¼Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ">----</div>
      <p style="color:var(--text2); font-size:12px; margin-bottom:8px;">
        ĞŸĞµÑ€ĞµĞ´Ğ°Ğ¹ ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ´ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºÑƒ
      </p>
      <p style="color:var(--text2); font-size:12px;">
        ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸ĞºĞ°<span class="waiting-dots"></span>
      </p>
      <button class="btn btn-sm" id="btnCancelWait" style="margin-top:20px;">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â• Ğ­ĞšĞ ĞĞ: Ğ˜Ğ“Ğ Ğ â•â•â•â•â•â•â• -->
  <div id="screenGame" style="display:none;">
    <div class="game-container">
      <!-- ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº (ÑĞ²ĞµÑ€Ñ…Ñƒ) -->
      <div class="player-bar" id="barOpponent">
        <div class="name">
          <div class="color-dot" id="dotOpponent"></div>
          <span id="nameOpponent">ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº</span>
        </div>
        <div class="timer" id="timerOpponent">60</div>
        <div class="captured" id="capturedOpponent">Ã—0</div>
      </div>

      <!-- Ğ”Ğ¾ÑĞºĞ° -->
      <div class="board-wrapper">
        <div class="board" id="board"></div>
      </div>

      <!-- Ğ˜Ğ³Ñ€Ğ¾Ğº (ÑĞ½Ğ¸Ğ·Ñƒ) -->
      <div class="player-bar" id="barPlayer">
        <div class="name">
          <div class="color-dot" id="dotPlayer"></div>
          <span id="namePlayer">Ğ’Ñ‹</span>
        </div>
        <div class="timer" id="timerPlayer">60</div>
        <div class="captured" id="capturedPlayer">Ã—0</div>
      </div>

      <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ -->
      <div class="game-controls">
        <button class="btn btn-sm" id="btnResign">Ğ¡Ğ´Ğ°Ñ‚ÑŒÑÑ</button>
        <button class="btn btn-sm" id="btnDraw">ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ½Ğ¸Ñ‡ÑŒÑ</button>
      </div>

      <!-- Ğ›Ğ¾Ğ³ Ñ…Ğ¾Ğ´Ğ¾Ğ² -->
      <div class="move-log" id="moveLog"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• ĞœĞĞ”ĞĞ›Ğ¬ĞĞĞ• ĞĞšĞĞ (Ğ¾Ğ±Ñ‰ĞµĞµ) â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal" style="display:none;">
  <div class="modal">
    <p id="modalText">Ğ¢ĞµĞºÑÑ‚</p>
    <div id="modalButtons"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• Ğ­ĞšĞ ĞĞ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ â•â•â•â•â•â•â• -->
<div class="result-overlay" id="screenResult" style="display:none;">
  <div class="result-text" id="resultText">ĞŸĞĞ‘Ğ•Ğ”Ğ</div>
  <div style="font-size:13px; color:var(--text2); margin-top:12px; letter-spacing:2px;" id="resultSub"></div>
  <div class="result-buttons">
    <button class="btn" id="btnRematch">Ğ ĞµĞ²Ğ°Ğ½Ñˆ</button>
    <button class="btn" id="btnToLobby">Ğ’ Ğ»Ğ¾Ğ±Ğ±Ğ¸</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   "Ğ¡Ğ¢ĞĞ Ğ˜ĞšĞĞœ Ğ¢Ğ£Ğ¢ ĞĞ• ĞœĞ•Ğ¡Ğ¢Ğ!" â€” Ğ ÑƒÑÑĞºĞ¸Ğµ ÑˆĞ°ÑˆĞºĞ¸ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½
   PeerJS WebRTC P2P â€” Ğ¾Ğ´Ğ¸Ğ½ Ñ„Ğ°Ğ¹Ğ», Ğ±ĞµĞ· ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—Ğ’Ğ£Ğš (Web Audio API)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let soundEnabled = true;

function ensureAudio() {
  if (!audioCtx) audioCtx = new AudioCtx();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playTone(freq, duration, gain = 0.15, type = 'sine') {
  if (!soundEnabled) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = gain;
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + duration);
}

function sndClick()   { playTone(800, 0.05, 0.12); }
function sndMove()    { playTone(400, 0.10, 0.15, 'triangle'); }
function sndCapture() { playTone(600, 0.08, 0.25, 'square'); }
function sndWin() {
  playTone(523, 0.15, 0.15); setTimeout(()=>playTone(659,0.15,0.15),150);
  setTimeout(()=>playTone(784,0.25,0.2),300);
}
function sndLose() {
  playTone(400, 0.2, 0.15); setTimeout(()=>playTone(300,0.3,0.15),200);
}

document.getElementById('soundBtn').addEventListener('click', () => {
  soundEnabled = !soundEnabled;
  document.getElementById('soundBtn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id) { return document.getElementById(id); }
function show(id) { $(id).style.display = ''; }
function hide(id) { $(id).style.display = 'none'; }
function genCode() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r = ''; for(let i=0;i<5;i++) r += c[Math.floor(Math.random()*c.length)];
  return r;
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

function vibrate(ms=50) {
  if (navigator.vibrate) navigator.vibrate(ms);
}

// Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
function notifyMove() {
  if (document.hidden && Notification.permission === 'granted') {
    new Notification('Ğ¡Ğ¢ĞĞ Ğ˜ĞšĞĞœ Ğ¢Ğ£Ğ¢ ĞĞ• ĞœĞ•Ğ¡Ğ¢Ğ!', { body: 'ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº ÑĞ´ĞµĞ»Ğ°Ğ» Ñ…Ğ¾Ğ´!' });
  }
}
if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

// Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° localStorage
function loadStats() {
  try { return JSON.parse(localStorage.getItem('checkers_stats')) || {w:0,l:0,d:0}; }
  catch { return {w:0,l:0,d:0}; }
}
function saveStats(s) { localStorage.setItem('checkers_stats', JSON.stringify(s)); }
function displayStats() {
  const s = loadStats();
  $('statsDisplay').innerHTML = `ĞŸĞ¾Ğ±ĞµĞ´: <span>${s.w}</span> | ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹: <span>${s.l}</span> | ĞĞ¸Ñ‡ÑŒĞ¸Ñ…: <span>${s.d}</span>`;
}
displayStats();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• Ğ˜Ğ“Ğ Ğ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/*
  board[row][col] :
    0  = Ğ¿ÑƒÑÑ‚Ğ¾
    1  = ÑˆĞ°ÑˆĞºĞ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° 1 (ĞºÑ€Ğ°ÑĞ½Ñ‹Ğµ)
    2  = ÑˆĞ°ÑˆĞºĞ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° 2 (Ğ±ĞµĞ»Ñ‹Ğµ)
    3  = Ğ´Ğ°Ğ¼ĞºĞ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° 1
    4  = Ğ´Ğ°Ğ¼ĞºĞ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° 2
*/

let gameState = {
  board: [],         // 8x8 Ğ¼Ğ°ÑÑĞ¸Ğ²
  turn: 1,           // Ñ‡ĞµĞ¹ Ñ…Ğ¾Ğ´ (1 Ğ¸Ğ»Ğ¸ 2)
  myColor: 0,        // Ñ†Ğ²ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° (1 Ğ¸Ğ»Ğ¸ 2)
  selected: null,     // {row, col}
  validMoves: [],     // [{row,col,captures:[...],path:[...]}]
  mustCapture: false,  // Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ²Ğ·ÑÑ‚Ğ¸Ğµ
  chainPiece: null,    // ÑˆĞ°ÑˆĞºĞ° Ğ² ÑĞµÑ€Ğ¸Ğ¸ Ğ²Ğ·ÑÑ‚Ğ¸Ğ¹ {row,col}
  captured1: 0,        // ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ±Ğ¸Ğ» Ğ¸Ğ³Ñ€Ğ¾Ğº 1
  captured2: 0,        // ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ±Ğ¸Ğ» Ğ¸Ğ³Ñ€Ğ¾Ğº 2
  moveNum: 0,
  isLocal: false,
  gameOver: false,
  timerPlayer: 60,
  timerOpponent: 60
};

let timerInterval = null;

function initBoard() {
  const b = Array.from({length:8}, ()=>Array(8).fill(0));
  // Ğ˜Ğ³Ñ€Ğ¾Ğº 2 (Ğ±ĞµĞ»Ñ‹Ğµ) â€” Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğµ 3 Ñ€ÑĞ´Ğ° (Ñ€ÑĞ´Ñ‹ 0-2)
  for (let r=0;r<3;r++)
    for (let c=0;c<8;c++)
      if ((r+c)%2===1) b[r][c] = 2;
  // Ğ˜Ğ³Ñ€Ğ¾Ğº 1 (ĞºÑ€Ğ°ÑĞ½Ñ‹Ğµ) â€” Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğµ 3 Ñ€ÑĞ´Ğ° (Ñ€ÑĞ´Ñ‹ 5-7)
  for (let r=5;r<8;r++)
    for (let c=0;c<8;c++)
      if ((r+c)%2===1) b[r][c] = 1;
  return b;
}

function cloneBoard(b) { return b.map(r=>[...r]); }

function ownerOf(piece) {
  if (piece === 1 || piece === 3) return 1;
  if (piece === 2 || piece === 4) return 2;
  return 0;
}
function isKing(piece) { return piece === 3 || piece === 4; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ›ĞĞ“Ğ˜ĞšĞ Ğ Ğ£Ğ¡Ğ¡ĞšĞ˜Ğ¥ Ğ¨ĞĞ¨Ğ•Ğš
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ñ…Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ ÑˆĞ°ÑˆĞºĞ¸ (row,col)
function getMovesForPiece(board, row, col, onlyCaptures=false) {
  const piece = board[row][col];
  const owner = ownerOf(piece);
  if (!owner) return [];
  const king = isKing(piece);
  const moves = [];

  if (king) {
    // Ğ”Ğ°Ğ¼ĞºĞ° â€” Ñ…Ğ¾Ğ´Ğ¸Ñ‚/Ğ±ÑŒÑ‘Ñ‚ Ğ¿Ğ¾ Ğ´Ğ¸Ğ°Ğ³Ğ¾Ğ½Ğ°Ğ»Ğ¸ Ğ½Ğ° Ğ»ÑĞ±Ğ¾Ğµ Ñ€Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    const dirs = [[-1,-1],[-1,1],[1,-1],[1,1]];
    for (const [dr,dc] of dirs) {
      let r=row+dr, c=col+dc;
      let foundEnemy = null;
      while (r>=0 && r<8 && c>=0 && c<8) {
        const cell = board[r][c];
        if (ownerOf(cell) === owner) break; // ÑĞ²Ğ¾Ğ¸ â€” ÑÑ‚Ğ¾Ğ¿
        if (ownerOf(cell) !== 0 && ownerOf(cell) !== owner) {
          if (foundEnemy) break; // Ğ²Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ²Ñ€Ğ°Ğ¶ĞµÑĞºĞ°Ñ â€” ÑÑ‚Ğ¾Ğ¿
          foundEnemy = {row:r, col:c};
          r+=dr; c+=dc;
          continue;
        }
        // ĞŸÑƒÑÑ‚Ğ°Ñ ĞºĞ»ĞµÑ‚ĞºĞ°
        if (foundEnemy) {
          // Ğ’Ğ·ÑÑ‚Ğ¸Ğµ â€” Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ·ĞµĞ¼Ğ»Ğ¸Ñ‚ÑŒÑÑ
          moves.push({row:r, col:c, captures:[foundEnemy], isCapture:true});
        } else if (!onlyCaptures) {
          // ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ñ…Ğ¾Ğ´
          moves.push({row:r, col:c, captures:[], isCapture:false});
        }
        r+=dr; c+=dc;
      }
    }
  } else {
    // ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ ÑˆĞ°ÑˆĞºĞ°
    const fwd = (owner===1) ? -1 : 1;
    // ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ Ñ…Ğ¾Ğ´Ñ‹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´)
    if (!onlyCaptures) {
      for (const dc of [-1,1]) {
        const nr=row+fwd, nc=col+dc;
        if (nr>=0 && nr<8 && nc>=0 && nc<8 && board[nr][nc]===0) {
          moves.push({row:nr, col:nc, captures:[], isCapture:false});
        }
      }
    }
    // Ğ’Ğ·ÑÑ‚Ğ¸Ñ (Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ Ğ˜ Ğ½Ğ°Ğ·Ğ°Ğ´)
    for (const dr of [-1,1]) {
      for (const dc of [-1,1]) {
        const mr=row+dr, mc=col+dc;
        const lr=row+2*dr, lc=col+2*dc;
        if (lr>=0 && lr<8 && lc>=0 && lc<8) {
          const mid = board[mr][mc];
          if (ownerOf(mid)!==0 && ownerOf(mid)!==owner && board[lr][lc]===0) {
            moves.push({row:lr, col:lc, captures:[{row:mr,col:mc}], isCapture:true});
          }
        }
      }
    }
  }
  return moves;
}

// ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ²ÑĞµ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ğ·ÑÑ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑˆĞ°ÑˆĞºĞ¸ (Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾)
function getCaptureChains(board, row, col, alreadyCaptured=[]) {
  const captures = getMovesForPiece(board, row, col, true);
  // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼: Ğ½Ğµ Ğ±Ğ¸Ñ‚ÑŒ ÑƒĞ¶Ğµ ÑĞ±Ğ¸Ñ‚ÑƒÑ ÑˆĞ°ÑˆĞºÑƒ (Ğ´Ğ»Ñ ÑĞµÑ€Ğ¸Ğ¸)
  const valid = captures.filter(m => {
    return !m.captures.some(c => alreadyCaptured.some(a => a.row===c.row && a.col===c.col));
  });

  if (valid.length === 0) {
    return alreadyCaptured.length > 0 ? [{ row, col, totalCaptures: [...alreadyCaptured] }] : [];
  }

  const chains = [];
  for (const m of valid) {
    const newBoard = cloneBoard(board);
    const piece = newBoard[row][col];
    newBoard[row][col] = 0;
    for (const c of m.captures) newBoard[c.row][c.col] = 0;
    newBoard[m.row][m.col] = piece;
    const newCaptured = [...alreadyCaptured, ...m.captures];
    const subChains = getCaptureChains(newBoard, m.row, m.col, newCaptured);
    if (subChains.length === 0) {
      chains.push({ row:m.row, col:m.col, totalCaptures: newCaptured });
    } else {
      chains.push(...subChains);
    }
  }
  return chains;
}

// Ğ’ÑĞµ Ğ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ñ‹Ğµ Ñ…Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
function getAllMoves(board, player) {
  const allCaptures = [];
  const allSimple = [];

  for (let r=0;r<8;r++) {
    for (let c=0;c<8;c++) {
      if (ownerOf(board[r][c]) !== player) continue;
      // Ğ¦ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ Ğ²Ğ·ÑÑ‚Ğ¸Ğ¹
      const chains = getCaptureChains(board, r, c);
      for (const ch of chains) {
        allCaptures.push({ from:{row:r,col:c}, to:{row:ch.row,col:ch.col}, captures:ch.totalCaptures, isCapture:true });
      }
      // ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ Ñ…Ğ¾Ğ´Ñ‹
      const simple = getMovesForPiece(board, r, c, false).filter(m=>!m.isCapture);
      for (const s of simple) {
        allSimple.push({ from:{row:r,col:c}, to:{row:s.row,col:s.col}, captures:[], isCapture:false });
      }
    }
  }

  // ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ²Ğ·ÑÑ‚Ğ¸Ğµ: ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ…Ğ¾Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾ Ğ²Ğ·ÑÑ‚Ğ¸Ğµ â€” Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ·ÑÑ‚Ğ¸Ñ
  if (allCaptures.length > 0) {
    // ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ´Ğ»Ğ¸Ğ½Ñƒ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸? Ğ’ Ñ€ÑƒÑÑĞºĞ¸Ñ… ÑˆĞ°ÑˆĞºĞ°Ñ…
    // ĞĞ• Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ±Ğ¸Ñ‚ÑŒ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼, Ğ½Ğ¾ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ±Ğ¸Ñ‚ÑŒ. ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ğ²Ğ·ÑÑ‚Ğ¸Ñ.
    return { moves: allCaptures, mustCapture: true };
  }
  return { moves: allSimple, mustCapture: false };
}

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ…Ğ¾Ğ´Ñ‹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ ÑˆĞ°ÑˆĞºĞ¸ Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ğ·ÑÑ‚Ğ¸Ñ
function getMovesFor(board, row, col, player) {
  const {moves, mustCapture} = getAllMoves(board, player);
  return {
    moves: moves.filter(m => m.from.row===row && m.from.col===col),
    mustCapture
  };
}

// ĞŸÑ€Ğ¾Ğ¼Ğ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ´Ğ°Ğ¼ĞºÑƒ
function shouldCrown(piece, row) {
  if (piece===1 && row===0) return 3;
  if (piece===2 && row===7) return 4;
  return piece;
}

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ†Ğ° Ğ¸Ğ³Ñ€Ñ‹
function checkGameOver(board, nextPlayer) {
  const {moves} = getAllMoves(board, nextPlayer);
  if (moves.length === 0) return true;
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑˆĞ°ÑˆĞºĞ¸
  let has = false;
  for (let r=0;r<8;r++) for (let c=0;c<8;c++) if (ownerOf(board[r][c])===nextPlayer) has=true;
  return !has;
}

// Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ…Ğ¾Ğ´Ğ°
function validateMove(board, player, from, to, captures) {
  const {moves} = getAllMoves(board, player);
  return moves.some(m =>
    m.from.row===from.row && m.from.col===from.col &&
    m.to.row===to.row && m.to.col===to.col &&
    m.captures.length===captures.length &&
    m.captures.every((c,i)=>c.row===captures[i].row && c.col===captures[i].col)
  );
}

// ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ…Ğ¾Ğ´
function applyMove(board, from, to, captures) {
  const b = cloneBoard(board);
  let piece = b[from.row][from.col];
  b[from.row][from.col] = 0;
  for (const c of captures) b[c.row][c.col] = 0;
  piece = shouldCrown(piece, to.row);
  b[to.row][to.col] = piece;
  return { board: b, crowned: isKing(piece) && !isKing(board[from.row][from.col]) };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ Ğ•ĞĞ”Ğ•Ğ  Ğ”ĞĞ¡ĞšĞ˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const boardEl = $('board');

function renderBoard() {
  boardEl.innerHTML = '';
  const flipped = (!gameState.isLocal && gameState.myColor === 2);

  for (let ri=0; ri<8; ri++) {
    for (let ci=0; ci<8; ci++) {
      const r = flipped ? 7-ri : ri;
      const c = flipped ? 7-ci : ci;

      const cell = document.createElement('div');
      cell.className = 'cell ' + ((r+c)%2===0 ? 'light' : 'dark');
      cell.dataset.row = r;
      cell.dataset.col = c;

      // ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹
      if (gameState.selected && gameState.selected.row===r && gameState.selected.col===c) {
        cell.classList.add('selected');
      }

      // ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ñ…Ğ¾Ğ´Ğ¾Ğ²
      if (gameState.validMoves.some(m=>m.to.row===r && m.to.col===c)) {
        cell.classList.add('highlight');
      }

      // Ğ¨Ğ°ÑˆĞºĞ°
      const piece = gameState.board[r][c];
      if (piece) {
        const p = document.createElement('div');
        p.className = 'piece ' + (ownerOf(piece)===1 ? 'p1' : 'p2');
        if (isKing(piece)) p.classList.add('king');
        if (gameState.selected && gameState.selected.row===r && gameState.selected.col===c) {
          p.classList.add('selected');
        }
        cell.appendChild(p);
      }

      cell.addEventListener('click', ()=>onCellClick(r,c));
      boardEl.appendChild(cell);
    }
  }

  updateUI();
}

function updateUI() {
  const isMyTurn = gameState.turn === gameState.myColor;
  const oppColor = gameState.myColor === 1 ? 2 : 1;

  // Ğ˜Ğ½Ñ„Ğ¾-Ğ±Ğ°Ñ€Ñ‹
  $('dotPlayer').style.background = gameState.myColor===1 ? 'var(--p1)' : 'var(--p2)';
  $('dotOpponent').style.background = oppColor===1 ? 'var(--p1)' : 'var(--p2)';
  $('namePlayer').textContent = gameState.myColor===1 ? 'Ğ’Ñ‹ (ĞºÑ€Ğ°ÑĞ½Ñ‹Ğµ)' : 'Ğ’Ñ‹ (Ğ±ĞµĞ»Ñ‹Ğµ)';
  $('nameOpponent').textContent = gameState.isLocal
    ? (gameState.turn===1 ? 'â† Ğ¥Ğ¾Ğ´ ĞºÑ€Ğ°ÑĞ½Ñ‹Ñ…' : 'â† Ğ¥Ğ¾Ğ´ Ğ±ĞµĞ»Ñ‹Ñ…')
    : (oppColor===1 ? 'ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº (ĞºÑ€Ğ°ÑĞ½Ñ‹Ğµ)' : 'ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº (Ğ±ĞµĞ»Ñ‹Ğµ)');

  $('barPlayer').className = 'player-bar' + (isMyTurn && !gameState.isLocal ? ' active-turn' : '') +
    (gameState.isLocal && gameState.turn===gameState.myColor ? ' active-turn' : '');
  $('barOpponent').className = 'player-bar' + (!isMyTurn && !gameState.isLocal ? ' active-turn' : '') +
    (gameState.isLocal && gameState.turn!==gameState.myColor ? ' active-turn' : '');

  $('capturedPlayer').textContent = 'Ã—' + (gameState.myColor===1 ? gameState.captured1 : gameState.captured2);
  $('capturedOpponent').textContent = 'Ã—' + (gameState.myColor===1 ? gameState.captured2 : gameState.captured1);

  // Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€Ñ‹
  $('timerPlayer').textContent = gameState.timerPlayer;
  $('timerOpponent').textContent = gameState.timerOpponent;
  $('timerPlayer').className = 'timer' + (gameState.timerPlayer <= 10 && isMyTurn ? ' urgent' : '');
  $('timerOpponent').className = 'timer' + (gameState.timerOpponent <= 10 && !isMyTurn ? ' urgent' : '');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞšĞ›Ğ˜ĞšĞĞ’ ĞŸĞ Ğ”ĞĞ¡ĞšĞ•
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onCellClick(row, col) {
  if (gameState.gameOver) return;

  const canPlay = gameState.isLocal || (gameState.turn === gameState.myColor);
  if (!canPlay) return;

  const currentPlayer = gameState.isLocal ? gameState.turn : gameState.myColor;
  const piece = gameState.board[row][col];

  // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ° Ğ²Ğ·ÑÑ‚Ğ¸Ğ¹ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ
  if (gameState.chainPiece) {
    // ĞœĞ¾Ğ¶Ğ½Ğ¾ ĞºĞ»Ğ¸ĞºĞ½ÑƒÑ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ğ´Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ
    const mv = gameState.validMoves.find(m=>m.to.row===row && m.to.col===col);
    if (mv) {
      executeMove(mv, currentPlayer);
    }
    return;
  }

  // ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‡ĞµĞ½Ğ½Ğ¾Ğ¹ ĞºĞ»ĞµÑ‚ĞºĞµ â€” Ñ…Ğ¾Ğ´
  const mv = gameState.validMoves.find(m=>m.to.row===row && m.to.col===col);
  if (mv) {
    sndClick();
    executeMove(mv, currentPlayer);
    return;
  }

  // ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ ÑĞ²Ğ¾ĞµĞ¹ ÑˆĞ°ÑˆĞºĞµ â€” Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ
  if (ownerOf(piece) === currentPlayer) {
    sndClick();
    const {moves, mustCapture} = getMovesFor(gameState.board, row, col, currentPlayer);
    gameState.selected = {row, col};
    gameState.validMoves = moves;
    gameState.mustCapture = mustCapture;
    renderBoard();
    return;
  }

  // ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ / Ñ‡ÑƒĞ¶Ğ¾Ğ¹ â€” ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€
  gameState.selected = null;
  gameState.validMoves = [];
  renderBoard();
}

function executeMove(mv, player) {
  const {board:newBoard, crowned} = applyMove(gameState.board, mv.from, mv.to, mv.captures);
  const captureCount = mv.captures.length;

  // Ğ—Ğ²ÑƒĞºĞ¸
  if (captureCount > 0) sndCapture(); else sndMove();

  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ²Ğ·ÑÑ‚Ğ¸Ğ¹
  if (player === 1) gameState.captured1 += captureCount;
  else gameState.captured2 += captureCount;

  gameState.board = newBoard;
  gameState.selected = null;
  gameState.validMoves = [];
  gameState.chainPiece = null;

  // Ğ›Ğ¾Ğ³ Ñ…Ğ¾Ğ´Ğ°
  logMove(player, mv.from, mv.to, captureCount, crowned);

  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ ÑĞµÑ‚Ğ¸
  if (!gameState.isLocal) {
    sendData({
      type:'move',
      from: mv.from,
      to: mv.to,
      captured: mv.captures,
      crowned: crowned
    });
  }

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ†Ğ° ÑĞµÑ€Ğ¸Ğ¸ Ğ²Ğ·ÑÑ‚Ğ¸Ğ¹ (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ ÑˆĞ°ÑˆĞºĞ¸ Ñ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ¾Ğ¼):
  // ĞĞ° ÑĞ°Ğ¼Ğ¾Ğ¼ Ğ´ĞµĞ»Ğµ Ğ² Ğ½Ğ°ÑˆĞµĞ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ñ‹
  // (getAllMoves ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸), Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¾Ğ´Ğ¸Ğ½ Ñ…Ğ¾Ğ´ = Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ°.

  // Ğ¡Ğ¼ĞµĞ½Ğ° Ñ…Ğ¾Ğ´Ğ°
  resetTimer();
  gameState.turn = player === 1 ? 2 : 1;

  // Ğ’ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¼ĞµĞ½ÑĞµĞ¼ myColor Ğ´Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¸
  if (gameState.isLocal) {
    gameState.myColor = gameState.turn;
  }

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ†Ğ° Ğ¸Ğ³Ñ€Ñ‹
  if (checkGameOver(gameState.board, gameState.turn)) {
    endGame(player === gameState.myColor ? 'win' :
      (gameState.isLocal ? (player===1 ? 'winRed' : 'winWhite') : 'lose'));
    return;
  }

  renderBoard();
}

function logMove(player, from, to, captures, crowned) {
  gameState.moveNum++;
  const letters = 'abcdefgh';
  const fromStr = letters[from.col] + (8-from.row);
  const toStr = letters[to.col] + (8-to.row);
  const sep = captures > 0 ? ':' : '-';
  const crownMark = crowned ? '(Ğ”)' : '';
  const color = player === 1 ? 'ğŸ”´' : 'âšª';
  const entry = document.createElement('div');
  entry.textContent = `${gameState.moveNum}. ${color} ${fromStr}${sep}${toStr} ${captures>0?'Ã—'+captures:''} ${crownMark}`;
  $('moveLog').appendChild(entry);
  $('moveLog').scrollTop = $('moveLog').scrollHeight;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¢ĞĞ™ĞœĞ•Ğ  Ğ¥ĞĞ”Ğ (60 ÑĞµĞºÑƒĞ½Ğ´)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetTimer() {
  gameState.timerPlayer = 60;
  gameState.timerOpponent = 60;
}

function startTimer() {
  stopTimer();
  timerInterval = setInterval(()=> {
    if (gameState.gameOver) { stopTimer(); return; }
    const isMyTurn = gameState.turn === gameState.myColor;
    if (isMyTurn) {
      gameState.timerPlayer--;
      if (gameState.timerPlayer <= 0) {
        // Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾ â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ğ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
        if (!gameState.isLocal) {
          sendData({type:'resign'});
          endGame('lose');
        } else {
          endGame(gameState.turn===1 ? 'winWhite' : 'winRed');
        }
      }
    } else if (!gameState.isLocal) {
      gameState.timerOpponent--;
      // ĞĞµ Ğ½Ğ°ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ¿Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° â€” Ğ¾Ğ½ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ²Ğ¾Ğ¸Ğ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼ ÑĞ°Ğ¼
    }
    updateUI();
  }, 1000);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval=null; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞšĞĞĞ•Ğ¦ Ğ˜Ğ“Ğ Ğ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endGame(result) {
  gameState.gameOver = true;
  stopTimer();

  const el = $('resultText');
  const sub = $('resultSub');

  if (result === 'win') {
    el.textContent = 'ĞŸĞĞ‘Ğ•Ğ”Ğ'; el.className = 'result-text win';
    sub.textContent = 'ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ¿Ğ¾Ğ²ĞµÑ€Ğ¶ĞµĞ½'; sndWin();
    const s=loadStats(); s.w++; saveStats(s);
  } else if (result === 'lose') {
    el.textContent = 'ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ•'; el.className = 'result-text lose';
    sub.textContent = 'Ğ’ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ€Ğ°Ğ· Ğ¿Ğ¾Ğ²ĞµĞ·Ñ‘Ñ‚'; sndLose();
    const s=loadStats(); s.l++; saveStats(s);
  } else if (result === 'draw') {
    el.textContent = 'ĞĞ˜Ğ§Ğ¬Ğ¯'; el.className = 'result-text draw';
    sub.textContent = 'Ğ”Ğ¾ÑÑ‚Ğ¾Ğ¹Ğ½Ğ°Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ';
    const s=loadStats(); s.d++; saveStats(s);
  } else if (result === 'disconnect') {
    el.textContent = 'ĞŸĞĞ‘Ğ•Ğ”Ğ'; el.className = 'result-text win';
    sub.textContent = 'ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ';
    const s=loadStats(); s.w++; saveStats(s);
  } else if (result === 'winRed') {
    el.textContent = 'ĞšĞ ĞĞ¡ĞĞ«Ğ• ĞŸĞĞ‘Ğ•Ğ”Ğ˜Ğ›Ğ˜'; el.className = 'result-text win';
    sub.textContent = ''; sndWin();
  } else if (result === 'winWhite') {
    el.textContent = 'Ğ‘Ğ•Ğ›Ğ«Ğ• ĞŸĞĞ‘Ğ•Ğ”Ğ˜Ğ›Ğ˜'; el.className = 'result-text lose';
    sub.textContent = ''; sndWin();
  }

  show('screenResult');
  displayStats();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¡Ğ•Ğ¢Ğ¬ â€” PeerJS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let peer = null;
let conn = null;
let roomCode = '';
let isHost = false;
let pingInterval = null;
let lastPingTime = 0;
let reconnectAttempts = 0;
const MAX_RECONNECT = 3;

function getPeerConfig() {
  const host = $('inputHost').value.trim() || '0.peerjs.com';
  const port = parseInt($('inputPort').value.trim()) || 443;
  const path = $('inputPath').value.trim() || '/';
  return { host, port, path, secure: port===443, debug: 1 };
}

function initPeer(id) {
  if (peer) { peer.destroy(); }
  const cfg = getPeerConfig();
  console.log('[PeerJS] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº', cfg.host, ':', cfg.port);
  peer = new Peer(id || undefined, cfg);

  peer.on('open', (myId) => {
    console.log('[PeerJS] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½, ID:', myId);
    $('statusDot').classList.add('online');
    $('statusText').textContent = 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ';
    $('btnCreate').disabled = false;
    $('btnJoin').disabled = false;
  });

  peer.on('error', (err) => {
    console.error('[PeerJS] ĞÑˆĞ¸Ğ±ĞºĞ°:', err.type, err);
    $('statusDot').classList.remove('online');
    if (err.type === 'peer-unavailable') {
      toast('ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!');
      $('statusText').textContent = 'ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°';
    } else if (err.type === 'unavailable-id') {
      // ID Ğ·Ğ°Ğ½ÑÑ‚, Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
      initPeer('CHKRS-' + genCode() + '-' + genCode());
    } else {
      $('statusText').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + err.type;
    }
  });

  peer.on('disconnected', () => {
    console.log('[PeerJS] ĞÑ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
    $('statusDot').classList.remove('online');
    $('statusText').textContent = 'ĞÑ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°';
    // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ
    if (!peer.destroyed) peer.reconnect();
  });

  peer.on('connection', (c) => {
    console.log('[PeerJS] Ğ’Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚:', c.peer);
    if (conn) { c.close(); return; } // ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ
    conn = c;
    setupConnection();
  });
}

function setupConnection() {
  conn.on('open', () => {
    console.log('[NET] Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾');
    toast('ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ!');
    reconnectAttempts = 0;
    startGame();
    startPing();
  });

  conn.on('data', (data) => {
    handleMessage(data);
  });

  conn.on('close', () => {
    console.log('[NET] Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¾');
    stopPing();
    if (!gameState.gameOver) {
      handleDisconnect();
    }
  });

  conn.on('error', (err) => {
    console.error('[NET] ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ:', err);
  });
}

function handleDisconnect() {
  reconnectAttempts++;
  if (reconnectAttempts <= MAX_RECONNECT) {
    toast(`Ğ¡Ğ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾. ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ${reconnectAttempts}/${MAX_RECONNECT}...`);
    // Ğ–Ğ´Ñ‘Ğ¼ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
    setTimeout(() => {
      if (!conn || !conn.open) {
        if (reconnectAttempts < MAX_RECONNECT) {
          handleDisconnect();
        } else {
          endGame('disconnect');
        }
      }
    }, 3000);
  } else {
    endGame('disconnect');
  }
}

function sendData(data) {
  if (conn && conn.open) {
    conn.send(data);
    console.log('[NET] ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:', data.type);
  }
}

function handleMessage(data) {
  console.log('[NET] ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾:', data.type);

  switch(data.type) {
    case 'move':
      // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ…Ğ¾Ğ´Ğ°
      if (!validateMove(gameState.board, gameState.turn, data.from, data.to, data.captured)) {
        console.error('[NET] ĞĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ñ…Ğ¾Ğ´ Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸ĞºĞ°!');
        toast('ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ñ…Ğ¾Ğ´!');
        return;
      }
      // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ…Ğ¾Ğ´
      const {board:nb, crowned} = applyMove(gameState.board, data.from, data.to, data.captured);
      const captCount = data.captured.length;
      if (captCount>0) sndCapture(); else sndMove();
      if (gameState.turn===1) gameState.captured1 += captCount;
      else gameState.captured2 += captCount;
      gameState.board = nb;
      logMove(gameState.turn, data.from, data.to, captCount, crowned);
      resetTimer();
      gameState.turn = gameState.turn===1 ? 2 : 1;
      gameState.selected = null;
      gameState.validMoves = [];
      gameState.chainPiece = null;
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ†Ğ° Ğ¸Ğ³Ñ€Ñ‹
      if (checkGameOver(gameState.board, gameState.turn)) {
        endGame(gameState.turn===gameState.myColor ? 'lose' : 'win');
      }
      renderBoard();
      vibrate();
      notifyMove();
      break;

    case 'resign':
      endGame('win');
      break;

    case 'draw_offer':
      showModal('ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ Ğ½Ğ¸Ñ‡ÑŒÑ', [
        {text:'ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ', action:()=>{sendData({type:'draw_accept'}); endGame('draw'); hideModal();}},
        {text:'ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ', action:()=>{sendData({type:'draw_decline'}); hideModal();}}
      ]);
      break;

    case 'draw_accept':
      endGame('draw');
      break;

    case 'draw_decline':
      toast('ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ğ» Ğ½Ğ¸Ñ‡ÑŒÑ');
      break;

    case 'rematch_offer':
      showModal('ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğº Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ Ñ€ĞµĞ²Ğ°Ğ½Ñˆ', [
        {text:'ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ', action:()=>{sendData({type:'rematch_accept'}); startRematch(); hideModal();}},
        {text:'ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ', action:()=>{hideModal();}}
      ]);
      break;

    case 'rematch_accept':
      startRematch();
      break;

    case 'ping':
      sendData({type:'pong', time:data.time});
      break;

    case 'pong':
      const ping = Date.now() - data.time;
      $('pingDisplay').textContent = `ĞŸĞ¸Ğ½Ğ³: ${ping}ms`;
      break;
  }
}

// ĞŸĞ¸Ğ½Ğ³
function startPing() {
  stopPing();
  pingInterval = setInterval(()=>{
    sendData({type:'ping', time:Date.now()});
  }, 5000);
}
function stopPing() {
  if (pingInterval) { clearInterval(pingInterval); pingInterval=null; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞœĞĞ”ĞĞ›Ğ¬ĞĞĞ• ĞĞšĞĞ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(text, buttons) {
  $('modalText').textContent = text;
  const bc = $('modalButtons');
  bc.innerHTML = '';
  for (const b of buttons) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm';
    btn.textContent = b.text;
    btn.addEventListener('click', b.action);
    bc.appendChild(btn);
  }
  show('modal');
}
function hideModal() { hide('modal'); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞĞ’Ğ˜Ğ“ĞĞ¦Ğ˜Ğ¯ Ğ­ĞšĞ ĞĞĞĞ’
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(name) {
  hide('screenLobby'); hide('screenWaiting'); hide('screenGame'); hide('screenResult');
  show('screen' + name);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ ĞšĞĞœĞĞĞ¢Ğ£
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnCreate').addEventListener('click', () => {
  sndClick();
  roomCode = genCode();
  const peerId = 'CHKRS-' + roomCode;
  isHost = true;
  console.log('[ROOM] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñƒ:', roomCode, 'â†’ PeerID:', peerId);

  // ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ¸Ñ€ Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¼ ID
  if (peer) peer.destroy();
  const cfg = getPeerConfig();
  peer = new Peer(peerId, cfg);

  peer.on('open', () => {
    console.log('[ROOM] Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ ĞºĞ°Ğº', peerId);
    $('roomCodeDisplay').textContent = roomCode;
    showScreen('Waiting');
  });

  peer.on('error', (err) => {
    console.error('[ROOM] ĞÑˆĞ¸Ğ±ĞºĞ°:', err);
    if (err.type === 'unavailable-id') {
      toast('ĞšĞ¾Ğ´ Ğ·Ğ°Ğ½ÑÑ‚, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·');
      roomCode = genCode();
      $('btnCreate').click();
    } else {
      toast('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + err.type);
    }
  });

  peer.on('connection', (c) => {
    console.log('[ROOM] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ Ğ¸Ğ³Ñ€Ğ¾Ğº:', c.peer);
    conn = c;
    setupConnection();
  });
});

// ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ´
$('roomCodeDisplay').addEventListener('click', () => {
  navigator.clipboard.writeText(roomCode).then(()=>toast('ĞšĞ¾Ğ´ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!')).catch(()=>{});
});

// ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ
$('btnCancelWait').addEventListener('click', () => {
  sndClick();
  if (peer) peer.destroy();
  initPeer();
  showScreen('Lobby');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ˜Ğ¢Ğ¬Ğ¡Ğ¯ Ğš ĞšĞĞœĞĞĞ¢Ğ•
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnJoin').addEventListener('click', () => {
  sndClick();
  const code = $('inputCode').value.trim().toUpperCase();
  if (!code || code.length < 3) { toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹'); return; }

  const targetId = 'CHKRS-' + code;
  isHost = false;
  console.log('[JOIN] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ÑÑÑŒ Ğº:', targetId);

  // ĞŸĞµÑ€ĞµĞ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¸Ñ€
  if (peer) peer.destroy();
  const cfg = getPeerConfig();
  peer = new Peer(undefined, cfg);

  peer.on('open', () => {
    console.log('[JOIN] ĞœĞ¾Ğ¹ ID:', peer.id);
    conn = peer.connect(targetId, { reliable: true, serialization: 'json' });
    setupConnection();
  });

  peer.on('error', (err) => {
    console.error('[JOIN] ĞÑˆĞ¸Ğ±ĞºĞ°:', err);
    toast('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ: ' + err.type);
    initPeer();
    showScreen('Lobby');
  });
});

// Enter Ğ² Ğ¿Ğ¾Ğ»Ğµ ĞºĞ¾Ğ´Ğ°
$('inputCode').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') $('btnJoin').click();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ›ĞĞšĞĞ›Ğ¬ĞĞĞ¯ Ğ˜Ğ“Ğ Ğ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnLocal').addEventListener('click', () => {
  sndClick();
  gameState.isLocal = true;
  gameState.myColor = 1;
  gameState.board = initBoard();
  gameState.turn = 1;
  gameState.captured1 = 0;
  gameState.captured2 = 0;
  gameState.moveNum = 0;
  gameState.gameOver = false;
  gameState.selected = null;
  gameState.validMoves = [];
  gameState.chainPiece = null;
  $('moveLog').innerHTML = '';
  $('btnResign').style.display = 'none';
  $('btnDraw').style.display = 'none';
  resetTimer();
  startTimer();
  showScreen('Game');
  renderBoard();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞĞ§ĞĞ›Ğ ĞĞĞ›ĞĞ™Ğ Ğ˜Ğ“Ğ Ğ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame() {
  gameState.isLocal = false;
  gameState.myColor = isHost ? 1 : 2; // Ñ…Ğ¾ÑÑ‚ = ĞºÑ€Ğ°ÑĞ½Ñ‹Ğµ, Ğ³Ğ¾ÑÑ‚ÑŒ = Ğ±ĞµĞ»Ñ‹Ğµ
  gameState.board = initBoard();
  gameState.turn = 1; // ĞºÑ€Ğ°ÑĞ½Ñ‹Ğµ Ñ…Ğ¾Ğ´ÑÑ‚ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼Ğ¸
  gameState.captured1 = 0;
  gameState.captured2 = 0;
  gameState.moveNum = 0;
  gameState.gameOver = false;
  gameState.selected = null;
  gameState.validMoves = [];
  gameState.chainPiece = null;
  $('moveLog').innerHTML = '';
  $('btnResign').style.display = '';
  $('btnDraw').style.display = '';
  resetTimer();
  startTimer();
  showScreen('Game');
  renderBoard();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ Ğ•Ğ’ĞĞĞ¨
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnRematch').addEventListener('click', () => {
  sndClick();
  if (gameState.isLocal) {
    startRematch();
    return;
  }
  sendData({type:'rematch_offer'});
  toast('ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ²Ğ°Ğ½ÑˆĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
});

function startRematch() {
  hide('screenResult');
  // ĞœĞµĞ½ÑĞµĞ¼ Ñ†Ğ²ĞµÑ‚Ğ°
  if (!gameState.isLocal) {
    isHost = !isHost;
    gameState.myColor = gameState.myColor === 1 ? 2 : 1;
  }
  gameState.board = initBoard();
  gameState.turn = 1;
  gameState.captured1 = 0;
  gameState.captured2 = 0;
  gameState.moveNum = 0;
  gameState.gameOver = false;
  gameState.selected = null;
  gameState.validMoves = [];
  gameState.chainPiece = null;
  $('moveLog').innerHTML = '';
  resetTimer();
  startTimer();
  showScreen('Game');
  renderBoard();
}

// Ğ’ Ğ»Ğ¾Ğ±Ğ±Ğ¸
$('btnToLobby').addEventListener('click', () => {
  sndClick();
  hide('screenResult');
  stopTimer();
  stopPing();
  if (conn) { conn.close(); conn = null; }
  if (peer) peer.destroy();
  initPeer();
  showScreen('Lobby');
  displayStats();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¡Ğ”ĞĞ¢Ğ¬Ğ¡Ğ¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnResign').addEventListener('click', () => {
  sndClick();
  showModal('Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑĞ´Ğ°Ñ‚ÑŒÑÑ?', [
    {text:'Ğ”Ğ°, ÑĞ´Ğ°ÑÑÑŒ', action:()=>{
      sendData({type:'resign'});
      endGame('lose');
      hideModal();
    }},
    {text:'ĞĞµÑ‚', action:hideModal}
  ]);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞ˜Ğ§Ğ¬Ğ¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnDraw').addEventListener('click', () => {
  sndClick();
  sendData({type:'draw_offer'});
  toast('ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ¸Ñ‡ÑŒĞµĞ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞŸĞ•Ğ Ğ•ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ• Ğš Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ£
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnReconnect').addEventListener('click', () => {
  sndClick();
  if (peer) peer.destroy();
  initPeer();
  toast('ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btnCreate').disabled = true;
$('btnJoin').disabled = true;
initPeer();
showScreen('Lobby');

console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('  Ğ¡Ğ¢ĞĞ Ğ˜ĞšĞĞœ Ğ¢Ğ£Ğ¢ ĞĞ• ĞœĞ•Ğ¡Ğ¢Ğ!');
console.log('  Ğ ÑƒÑÑĞºĞ¸Ğµ ÑˆĞ°ÑˆĞºĞ¸ â€” P2P Online');
console.log('  PeerJS WebRTC');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
</script>
</body>
</html>
