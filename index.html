<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–®–∞—à–∫–∏ ‚Äî –°—Ç–∞—Ä–∏–∫–∞–º —Ç—É—Ç –Ω–µ –º–µ—Å—Ç–æ!</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Russo+One&family=Press+Start+2P&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #0a0a0a;
  color: #e0e0e0;
  font-family: 'Russo One', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(255,0,0,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 50%, rgba(255,60,0,0.06) 0%, transparent 50%);
  z-index: -1;
  animation: bgPulse 8s ease-in-out infinite alternate;
}

@keyframes bgPulse {
  0% { opacity: 0.5; }
  100% { opacity: 1; }
}

.header {
  text-align: center;
  padding: 25px 20px 10px;
}

.header h1 {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(14px, 3.5vw, 32px);
  color: #ff2200;
  text-shadow: 0 0 10px rgba(255,34,0,0.8), 0 0 40px rgba(255,34,0,0.4);
  animation: titleGlow 3s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  0% { text-shadow: 0 0 10px rgba(255,34,0,0.8), 0 0 40px rgba(255,34,0,0.4); }
  100% { text-shadow: 0 0 20px rgba(255,34,0,1), 0 0 60px rgba(255,34,0,0.6); }
}

.header .subtitle { font-size: 13px; color: #666; margin-top: 6px; }

/* LOBBY */
.lobby { max-width: 500px; margin: 20px auto; padding: 0 20px; }

.lobby-box {
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 1px solid #333;
  border-radius: 16px;
  padding: 25px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.lobby-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, #ff2200, transparent);
}

.lobby-box h2 {
  font-size: 18px;
  color: #ff4444;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 28px;
  font-family: 'Russo One', sans-serif;
  font-size: 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: linear-gradient(135deg, #ff2200, #cc1100);
  color: white;
  box-shadow: 0 4px 20px rgba(255,34,0,0.3);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 30px rgba(255,34,0,0.5);
}

.btn-secondary {
  background: linear-gradient(135deg, #333, #222);
  color: #ccc;
  border: 1px solid #444;
}

.btn-secondary:hover { border-color: #ff4444; color: white; }

.input-group { margin-bottom: 15px; }

.input-group label {
  display: block;
  font-size: 12px;
  color: #888;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.input-group input {
  width: 100%;
  padding: 12px 16px;
  background: #0d0d0d;
  border: 1px solid #333;
  border-radius: 8px;
  color: #fff;
  font-family: 'Russo One', sans-serif;
  font-size: 18px;
  text-align: center;
  letter-spacing: 4px;
  transition: border-color 0.3s;
}

.input-group input:focus {
  outline: none;
  border-color: #ff4444;
  box-shadow: 0 0 15px rgba(255,68,68,0.2);
}

.room-code {
  background: #0d0d0d;
  border: 2px dashed #ff4444;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin: 15px 0;
  cursor: pointer;
  transition: all 0.3s;
}

.room-code:hover { background: #1a0a0a; border-style: solid; }

.room-code .code {
  font-family: 'Press Start 2P', monospace;
  font-size: 22px;
  color: #ff4444;
  letter-spacing: 4px;
  word-break: break-all;
}

.room-code .hint { font-size: 11px; color: #666; margin-top: 8px; }

.divider {
  text-align: center;
  margin: 20px 0;
  position: relative;
}

.divider::before, .divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: 40%;
  height: 1px;
  background: #333;
}

.divider::before { left: 0; }
.divider::after { right: 0; }
.divider span { background: #0a0a0a; padding: 0 15px; color: #555; font-size: 13px; }

.status-bar {
  text-align: center;
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
  font-size: 13px;
}

.status-bar.waiting {
  background: rgba(255,165,0,0.1);
  border: 1px solid rgba(255,165,0,0.3);
  color: #ffaa44;
  animation: statusPulse 2s ease-in-out infinite;
}

.status-bar.connecting {
  background: rgba(0,150,255,0.1);
  border: 1px solid rgba(0,150,255,0.3);
  color: #44aaff;
  animation: statusPulse 1s ease-in-out infinite;
}

.status-bar.connected {
  background: rgba(0,255,100,0.1);
  border: 1px solid rgba(0,255,100,0.3);
  color: #44ff88;
}

.status-bar.error {
  background: rgba(255,0,0,0.1);
  border: 1px solid rgba(255,0,0,0.3);
  color: #ff4444;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* SERVER SELECTOR */
.server-info {
  font-size: 11px;
  color: #555;
  text-align: center;
  margin-top: 10px;
}

.server-info select {
  background: #111;
  color: #888;
  border: 1px solid #333;
  border-radius: 4px;
  padding: 4px 8px;
  font-family: 'Russo One', sans-serif;
  font-size: 11px;
  cursor: pointer;
}

/* GAME */
.game-screen {
  display: none;
  max-width: 700px;
  margin: 15px auto;
  padding: 0 15px;
}

.game-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding: 12px 16px;
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 1px solid #333;
  border-radius: 12px;
  flex-wrap: wrap;
  gap: 8px;
}

.player-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.player-info .piece-preview {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid #555;
  flex-shrink: 0;
}

.player-info .piece-preview.red {
  background: radial-gradient(circle at 35% 35%, #ff6644, #cc2200);
  border-color: #ff4444;
}

.player-info .piece-preview.black {
  background: radial-gradient(circle at 35% 35%, #555, #111);
  border-color: #777;
}

.player-info .name { font-size: 13px; }
.player-info .score { font-size: 11px; color: #888; }

.turn-indicator {
  text-align: center;
  font-size: 12px;
  padding: 5px 14px;
  border-radius: 20px;
  font-weight: bold;
  white-space: nowrap;
}

.turn-indicator.your-turn {
  background: rgba(255,34,0,0.2);
  color: #ff4444;
  border: 1px solid rgba(255,34,0,0.3);
  animation: turnPulse 1.5s ease-in-out infinite;
}

.turn-indicator.opponent-turn {
  background: rgba(255,255,255,0.05);
  color: #666;
  border: 1px solid #333;
}

@keyframes turnPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255,34,0,0.3); }
  50% { box-shadow: 0 0 0 8px rgba(255,34,0,0); }
}

/* BOARD */
.board-container {
  display: flex;
  justify-content: center;
  margin-bottom: 12px;
}

.board {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  border: 3px solid #444;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 0 30px rgba(0,0,0,0.8), 0 0 60px rgba(255,34,0,0.08);
  width: min(88vw, 560px);
  height: min(88vw, 560px);
}

.cell {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  cursor: default;
}

.cell.light { background: #d4a574; }
.cell.dark { background: #8b5e3c; }

.cell.dark.highlight {
  background: rgba(255,200,0,0.45);
  cursor: pointer;
}

.cell.dark.highlight::after {
  content: '';
  position: absolute;
  width: 28%;
  height: 28%;
  border-radius: 50%;
  background: rgba(255,200,0,0.7);
  animation: dotP 1s ease-in-out infinite;
}

.cell.dark.capture-highlight {
  background: rgba(255,0,0,0.4);
  cursor: pointer;
}

.cell.dark.capture-highlight::after {
  content: '';
  position: absolute;
  width: 34%;
  height: 34%;
  border-radius: 50%;
  background: rgba(255,0,0,0.7);
  animation: dotP 0.8s ease-in-out infinite;
}

@keyframes dotP {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.5; }
}

/* PIECES */
.piece {
  width: 78%;
  height: 78%;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  z-index: 2;
}

.piece.red {
  background: radial-gradient(circle at 35% 35%, #ff8866, #dd3311, #991100);
  border: 2px solid #ff6644;
  box-shadow: 0 3px 8px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.2);
}

.piece.black-piece {
  background: radial-gradient(circle at 35% 35%, #666, #333, #111);
  border: 2px solid #888;
  box-shadow: 0 3px 8px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.1);
}

.piece:hover { transform: scale(1.08); filter: brightness(1.15); }

.piece.selected { transform: scale(1.12); animation: selP 1s ease-in-out infinite; }

.piece.selected.red {
  box-shadow: 0 0 0 3px rgba(255,68,68,0.5), 0 0 20px rgba(255,34,0,0.5);
}

.piece.selected.black-piece {
  box-shadow: 0 0 0 3px rgba(150,150,150,0.5), 0 0 20px rgba(150,150,150,0.3);
}

@keyframes selP {
  0%, 100% { filter: brightness(1.2); }
  50% { filter: brightness(1.4); }
}

.piece.king::after {
  content: '‚ôõ';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(14px, 3.5vw, 26px);
  color: gold;
  text-shadow: 0 0 8px rgba(255,215,0,0.8);
}

.piece.no-click { cursor: default; pointer-events: none; }

/* LOG */
.game-log {
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 1px solid #333;
  border-radius: 10px;
  padding: 12px;
  max-height: 120px;
  overflow-y: auto;
  margin-bottom: 12px;
}

.game-log h3 { font-size: 12px; color: #555; margin-bottom: 6px; text-transform: uppercase; }

.game-log .log-entry {
  font-size: 11px;
  color: #777;
  padding: 2px 0;
  border-bottom: 1px solid #1a1a1a;
}

.game-log .log-entry.important { color: #ff4444; }

.game-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}

.game-actions .btn { width: auto; padding: 10px 20px; font-size: 12px; }

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.85);
  z-index: 100;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active { display: flex; }

.modal {
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 2px solid #ff4444;
  border-radius: 20px;
  padding: 35px;
  text-align: center;
  max-width: 380px;
  width: 90%;
  animation: modalIn 0.4s ease;
}

@keyframes modalIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal .result-icon { font-size: 56px; margin-bottom: 12px; }
.modal h2 { font-family: 'Press Start 2P', monospace; font-size: 20px; color: #ff4444; margin-bottom: 8px; }
.modal p { color: #999; margin-bottom: 20px; font-size: 14px; }

/* TOAST */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #222;
  color: #fff;
  padding: 12px 24px;
  border-radius: 8px;
  border: 1px solid #ff4444;
  font-family: 'Russo One', sans-serif;
  font-size: 13px;
  z-index: 200;
  transition: transform 0.3s ease;
  pointer-events: none;
  max-width: 90%;
  text-align: center;
}

.toast.show { transform: translateX(-50%) translateY(0); }

.particle {
  position: fixed;
  pointer-events: none;
  z-index: 300;
  border-radius: 50%;
  animation: particleFly 1s ease-out forwards;
}

@keyframes particleFly {
  0% { opacity: 1; transform: translate(0,0) scale(1); }
  100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0); }
}

.hidden { display: none !important; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: #111; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

.retry-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background: #222;
  color: #ff6644;
  border: 1px solid #ff4444;
  border-radius: 6px;
  cursor: pointer;
  font-family: 'Russo One', sans-serif;
  font-size: 12px;
}

.retry-btn:hover { background: #331111; }
</style>
</head>
<body>

<div class="header">
  <h1>üéØ –°–¢–ê–†–ò–ö–ê–ú –¢–£–¢ –ù–ï –ú–ï–°–¢–û</h1>
  <p class="subtitle">–û–Ω–ª–∞–π–Ω —à–∞—à–∫–∏ ‚Äî P2P –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</p>
</div>

<!-- LOBBY -->
<div class="lobby" id="lobby">

  <div class="lobby-box">
    <h2><span>üî•</span> –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</h2>
    <p style="color:#888; font-size:12px; margin-bottom:15px;">
      –°–æ–∑–¥–∞–π –∫–æ–º–Ω–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –¥—Ä—É–≥—É
    </p>
    <button class="btn btn-primary" id="btnCreate" onclick="createRoom()">
      ‚ö° –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
    </button>
    <div id="roomCodeBox" class="hidden">
      <div class="room-code" onclick="copyCode()">
        <div class="code" id="myRoomCode">---</div>
        <div class="hint">üìã –ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
      </div>
      <div class="status-bar waiting" id="waitStatus">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>
    </div>
    <div id="createError" class="hidden">
      <div class="status-bar error" id="createErrorMsg">–û—à–∏–±–∫–∞</div>
      <button class="retry-btn" onclick="retryCreate()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä</button>
    </div>
  </div>

  <div class="divider"><span>–ò–õ–ò</span></div>

  <div class="lobby-box">
    <h2><span>üéÆ</span> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h2>
    <div class="input-group">
      <label>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</label>
      <input type="text" id="joinCode" placeholder="–í–í–ï–î–ò –ö–û–î" maxlength="30"
             oninput="this.value=this.value.toUpperCase()">
    </div>
    <button class="btn btn-primary" id="btnJoin" onclick="joinRoom()">
      üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
    </button>
    <div id="joinStatus" class="hidden">
      <div class="status-bar connecting" id="joinStatusMsg">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
    </div>
  </div>

  <div class="server-info">
    –°–µ—Ä–≤–µ—Ä: <select id="serverSelect" onchange="onServerChange()">
      <option value="0">PeerJS Cloud (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
      <option value="1">Scaledrone Fallback</option>
      <option value="2">Metered TURN</option>
    </select>
  </div>
</div>

<!-- GAME -->
<div class="game-screen" id="gameScreen">
  <div class="game-info">
    <div class="player-info">
      <div class="piece-preview" id="myColorPreview"></div>
      <div>
        <div class="name" id="myLabel">–í—ã</div>
        <div class="score" id="myScore">12</div>
      </div>
    </div>
    <div class="turn-indicator" id="turnIndicator">–í–∞—à —Ö–æ–¥</div>
    <div class="player-info">
      <div>
        <div class="name" id="oppLabel">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
        <div class="score" id="oppScore">12</div>
      </div>
      <div class="piece-preview" id="oppColorPreview"></div>
    </div>
  </div>

  <div class="board-container">
    <div class="board" id="board"></div>
  </div>

  <div class="game-log" id="gameLog">
    <h3>üìú –ñ—É—Ä–Ω–∞–ª</h3>
  </div>

  <div class="game-actions">
    <button class="btn btn-secondary" onclick="surrender()">üè≥Ô∏è –°–¥–∞—Ç—å—Å—è</button>
    <button class="btn btn-secondary" onclick="offerDraw()">ü§ù –ù–∏—á—å—è</button>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="result-icon" id="resultIcon">üèÜ</div>
    <h2 id="resultTitle">–ü–æ–±–µ–¥–∞!</h2>
    <p id="resultText">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏</p>
    <button class="btn btn-primary" onclick="backToLobby()" style="width:auto; padding:12px 30px;">
      üîÑ –í –ª–æ–±–±–∏
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===========================
//  PEER SERVERS CONFIG
// ===========================
const PEER_CONFIGS = [
  // Default PeerJS cloud
  {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    path: '/',
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
        { urls: 'stun:stun.stunprotocol.org:3478' }
      ]
    }
  },
  // Alternative 1
  {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    path: '/',
    config: {
      iceServers: [
        { urls: 'stun:stun.stunprotocol.org:3478' },
        { urls: 'stun:stun.l.google.com:19302' },
        {
          urls: 'turn:openrelay.metered.ca:80',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        },
        {
          urls: 'turn:openrelay.metered.ca:443',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        }
      ]
    }
  },
  // Alternative 2 with TURN
  {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    path: '/',
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        {
          urls: 'turn:openrelay.metered.ca:443?transport=tcp',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        }
      ]
    }
  }
];

let currentServerIdx = 0;
let peer = null;
let conn = null;
let myColor = null;
let board_data = [];
let selectedCell = null;
let validMoves = [];
let currentTurn = 'red';
let isHost = false;
let gameActive = false;
let forcedCaptures = [];
let multiJumpPiece = null;
let connectionTimeout = null;
let retryCount = 0;

// ===========================
//  PEER CONNECTION
// ===========================
function generateId() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = 'SH';
  for(let i = 0; i < 8; i++) id += c[Math.floor(Math.random() * c.length)];
  return id;
}

function getPeerConfig() {
  return PEER_CONFIGS[currentServerIdx] || PEER_CONFIGS[0];
}

function onServerChange() {
  currentServerIdx = parseInt(document.getElementById('serverSelect').value);
}

function createRoom() {
  const roomId = generateId();
  const btn = document.getElementById('btnCreate');
  btn.disabled = true;
  btn.textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
  document.getElementById('createError').classList.add('hidden');

  const cfg = getPeerConfig();

  if(peer) { peer.destroy(); peer = null; }

  peer = new Peer(roomId, cfg);

  connectionTimeout = setTimeout(() => {
    if(peer && !peer.open) {
      peer.destroy();
      showCreateError('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.');
    }
  }, 10000);

  peer.on('open', (id) => {
    clearTimeout(connectionTimeout);
    document.getElementById('myRoomCode').textContent = id;
    document.getElementById('roomCodeBox').classList.remove('hidden');
    btn.textContent = '‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞';
    isHost = true;
    myColor = 'red';
    addLogLobby('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + id);
  });

  peer.on('connection', (connection) => {
    conn = connection;
    setupConnection();
    const ws = document.getElementById('waitStatus');
    ws.textContent = '‚úÖ –°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!';
    ws.className = 'status-bar connected';
    setTimeout(() => {
      conn.send({ type: 'start', color: 'black' });
      startGame();
    }, 600);
  });

  peer.on('error', (err) => {
    clearTimeout(connectionTimeout);
    console.error('Peer error:', err);
    showCreateError(`–û—à–∏–±–∫–∞: ${err.type}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä.`);
  });

  peer.on('disconnected', () => {
    console.log('Peer disconnected, reconnecting...');
    if(peer && !peer.destroyed) {
      peer.reconnect();
    }
  });
}

function showCreateError(msg) {
  const btn = document.getElementById('btnCreate');
  btn.disabled = false;
  btn.textContent = '‚ö° –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É';
  document.getElementById('roomCodeBox').classList.add('hidden');
  document.getElementById('createError').classList.remove('hidden');
  document.getElementById('createErrorMsg').textContent = '‚ùå ' + msg;
}

function retryCreate() {
  retryCount++;
  currentServerIdx = retryCount % PEER_CONFIGS.length;
  document.getElementById('serverSelect').value = currentServerIdx;
  document.getElementById('createError').classList.add('hidden');
  showToast(`üîÑ –ü—Ä–æ–±—É–µ–º —Å–µ—Ä–≤–µ—Ä ${currentServerIdx + 1}...`);
  createRoom();
}

function joinRoom() {
  const code = document.getElementById('joinCode').value.trim();
  if(!code) {
    showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
    return;
  }

  const btn = document.getElementById('btnJoin');
  btn.disabled = true;
  document.getElementById('joinStatus').classList.remove('hidden');
  const statusEl = document.getElementById('joinStatusMsg');
  statusEl.textContent = 'üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
  statusEl.className = 'status-bar connecting';

  const cfg = getPeerConfig();

  if(peer) { peer.destroy(); peer = null; }

  peer = new Peer(undefined, cfg);

  connectionTimeout = setTimeout(() => {
    if(peer && !peer.open) {
      peer.destroy();
      statusEl.textContent = '‚ùå –¢–∞–π–º–∞—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –∏–ª–∏ —Å–º–µ–Ω–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä.';
      statusEl.className = 'status-bar error';
      btn.disabled = false;
    }
  }, 12000);

  peer.on('open', () => {
    clearTimeout(connectionTimeout);
    statusEl.textContent = 'üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...';

    conn = peer.connect(code, { reliable: true, serialization: 'json' });

    const joinTimeout = setTimeout(() => {
      statusEl.textContent = '‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π';
      statusEl.className = 'status-bar error';
      btn.disabled = false;
    }, 10000);

    conn.on('open', () => {
      clearTimeout(joinTimeout);
      statusEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!';
      statusEl.className = 'status-bar connected';
      setupConnection();
    });

    conn.on('error', (err) => {
      clearTimeout(joinTimeout);
      statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + err;
      statusEl.className = 'status-bar error';
      btn.disabled = false;
    });
  });

  peer.on('error', (err) => {
    clearTimeout(connectionTimeout);
    console.error('Join peer error:', err);
    if(err.type === 'peer-unavailable') {
      statusEl.textContent = '‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥.';
    } else {
      statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + err.type;
    }
    statusEl.className = 'status-bar error';
    btn.disabled = false;
  });
}

function setupConnection() {
  conn.on('data', handleMessage);

  conn.on('close', () => {
    if(gameActive) {
      showToast('‚ö†Ô∏è –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
      endGame('–°–æ–ø–µ—Ä–Ω–∏–∫ —Å–±–µ–∂–∞–ª!', '–ü–æ–±–µ–¥–∞ ‚Äî —Å–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è', 'üèÉ');
    }
  });

  conn.on('error', (err) => {
    console.error('Connection error:', err);
    showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
  });
}

function handleMessage(data) {
  if(!data || !data.type) return;
  switch(data.type) {
    case 'start':
      myColor = data.color;
      startGame();
      break;
    case 'move':
      executeMove(data.from, data.to, false);
      break;
    case 'surrender':
      endGame('–ü–æ–±–µ–¥–∞!', '–°–æ–ø–µ—Ä–Ω–∏–∫ —Å–¥–∞–ª—Å—è üè≥Ô∏è', 'üèÜ');
      break;
    case 'offerDraw':
      if(confirm('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∏—á—å—é. –ü—Ä–∏–Ω—è—Ç—å?')) {
        conn.send({ type: 'acceptDraw' });
        endGame('–ù–∏—á—å—è!', '–û–±–æ—é–¥–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ', 'ü§ù');
      } else {
        conn.send({ type: 'declineDraw' });
      }
      break;
    case 'acceptDraw':
      endGame('–ù–∏—á—å—è!', '–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–∏–Ω—è–ª –Ω–∏—á—å—é', 'ü§ù');
      break;
    case 'declineDraw':
      showToast('‚ùå –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª –Ω–∏—á—å—é');
      break;
    case 'ping':
      conn.send({ type: 'pong' });
      break;
  }
}

function copyCode() {
  const code = document.getElementById('myRoomCode').textContent;
  if(navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(() => showToast('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')).catch(() => fallbackCopy(code));
  } else {
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  try { document.execCommand('copy'); showToast('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'); }
  catch(e) { showToast('–ö–æ–¥: ' + text); }
  document.body.removeChild(ta);
}

// ===========================
//  GAME LOGIC
// ===========================
function initBoard() {
  board_data = [];
  for(let r = 0; r < 8; r++) {
    board_data[r] = [];
    for(let c = 0; c < 8; c++) {
      board_data[r][c] = null;
      if((r + c) % 2 === 1) {
        if(r < 3) board_data[r][c] = { color: 'black', king: false };
        else if(r > 4) board_data[r][c] = { color: 'red', king: false };
      }
    }
  }
  currentTurn = 'red';
  selectedCell = null;
  validMoves = [];
  multiJumpPiece = null;
  forcedCaptures = [];
}

function startGame() {
  gameActive = true;
  initBoard();
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('gameScreen').style.display = 'block';

  document.getElementById('myColorPreview').className = 'piece-preview ' + myColor;
  document.getElementById('oppColorPreview').className = 'piece-preview ' + (myColor === 'red' ? 'black' : 'red');
  document.getElementById('myLabel').textContent = myColor === 'red' ? '–í—ã üî¥' : '–í—ã ‚ö´';
  document.getElementById('oppLabel').textContent = myColor === 'red' ? '–°–æ–ø–µ—Ä–Ω–∏–∫ ‚ö´' : '–°–æ–ø–µ—Ä–Ω–∏–∫ üî¥';

  addLog('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', true);
  addLog(myColor === 'red' ? 'üî¥ –í–∞—à —Ö–æ–¥ –ø–µ—Ä–≤—ã–π!' : '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (–∫—Ä–∞—Å–Ω—ã–µ)', myColor === 'red');

  renderBoard();
  updateTurnUI();

  // Keepalive ping
  setInterval(() => {
    if(conn && conn.open) conn.send({ type: 'ping' });
  }, 25000);
}

function renderBoard() {
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';
  const flip = (myColor === 'black');

  for(let ri = 0; ri < 8; ri++) {
    for(let ci = 0; ci < 8; ci++) {
      const r = flip ? 7 - ri : ri;
      const c = flip ? 7 - ci : ci;
      const cell = document.createElement('div');
      const isDark = (r + c) % 2 === 1;
      cell.className = 'cell ' + (isDark ? 'dark' : 'light');

      if(isDark) {
        const mv = validMoves.find(m => m.row === r && m.col === c);
        if(mv) {
          cell.classList.add(mv.capture ? 'capture-highlight' : 'highlight');
          cell.addEventListener('click', () => onMoveClick(r, c));
        }
      }

      const p = board_data[r][c];
      if(p) {
        const pe = document.createElement('div');
        pe.className = 'piece ' + (p.color === 'red' ? 'red' : 'black-piece');
        if(p.king) pe.classList.add('king');
        if(selectedCell && selectedCell.row === r && selectedCell.col === c) pe.classList.add('selected');

        if(p.color === myColor && currentTurn === myColor && gameActive) {
          pe.addEventListener('click', (e) => { e.stopPropagation(); onPieceClick(r, c); });
        } else {
          pe.classList.add('no-click');
        }
        cell.appendChild(pe);
      }

      boardEl.appendChild(cell);
    }
  }
  updateScores();
}

function onPieceClick(r, c) {
  if(currentTurn !== myColor || !gameActive) return;
  if(multiJumpPiece && (multiJumpPiece.row !== r || multiJumpPiece.col !== c)) {
    showToast('‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–µ—Ä–∏—é –≤–∑—è—Ç–∏–π!');
    return;
  }

  findForcedCaptures();
  if(forcedCaptures.length > 0 && !forcedCaptures.some(fc => fc.row === r && fc.col === c)) {
    showToast('‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –≤–∑—è—Ç–∏–µ!');
    return;
  }

  selectedCell = { row: r, col: c };
  validMoves = getValidMoves(r, c);
  if(forcedCaptures.length > 0) validMoves = validMoves.filter(m => m.capture);

  renderBoard();
}

function onMoveClick(r, c) {
  if(!selectedCell) return;
  const mv = validMoves.find(m => m.row === r && m.col === c);
  if(!mv) return;

  if(conn && conn.open) {
    conn.send({ type: 'move', from: { row: selectedCell.row, col: selectedCell.col }, to: { row: r, col: c } });
  }
  executeMove(selectedCell, { row: r, col: c }, true);
}

function executeMove(from, to, isMyMove) {
  const piece = board_data[from.row][from.col];
  if(!piece) return;

  const dr = to.row - from.row;
  const dc = to.col - from.col;
  let captured = false;

  board_data[to.row][to.col] = piece;
  board_data[from.row][from.col] = null;

  if(Math.abs(dr) === 2 && Math.abs(dc) === 2) {
    const cr = from.row + dr / 2;
    const cc = from.col + dc / 2;
    board_data[cr][cc] = null;
    captured = true;
    addLog(`${piece.color === 'red' ? 'üî¥' : '‚ö´'} –±—å—ë—Ç!`, true);
    spawnParticles(to.row, to.col);
  }

  // Promotion
  if(piece.color === 'red' && to.row === 0 && !piece.king) {
    piece.king = true;
    addLog('üî¥ ‚Üí üëë –î–∞–º–∫–∞!', true);
  }
  if(piece.color === 'black' && to.row === 7 && !piece.king) {
    piece.king = true;
    addLog('‚ö´ ‚Üí üëë –î–∞–º–∫–∞!', true);
  }

  // Multi-jump
  if(captured) {
    const next = getValidMoves(to.row, to.col).filter(m => m.capture);
    if(next.length > 0) {
      multiJumpPiece = { row: to.row, col: to.col };
      if((isMyMove && piece.color === myColor) || (!isMyMove && piece.color !== myColor)) {
        selectedCell = { row: to.row, col: to.col };
        validMoves = next;
      } else {
        selectedCell = null;
        validMoves = [];
      }
      renderBoard();
      return;
    }
  }

  multiJumpPiece = null;
  selectedCell = null;
  validMoves = [];
  forcedCaptures = [];
  currentTurn = currentTurn === 'red' ? 'black' : 'red';

  renderBoard();
  updateTurnUI();
  checkWinCondition();
}

function getValidMoves(r, c) {
  const p = board_data[r][c];
  if(!p) return [];
  const moves = [];

  // Normal moves
  let dirs;
  if(p.king) dirs = [[-1,-1],[-1,1],[1,-1],[1,1]];
  else if(p.color === 'red') dirs = [[-1,-1],[-1,1]];
  else dirs = [[1,-1],[1,1]];

  for(const [dr, dc] of dirs) {
    const nr = r + dr, nc = c + dc;
    if(nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && !board_data[nr][nc]) {
      moves.push({ row: nr, col: nc, capture: false });
    }
  }

  // Captures (all 4 dirs for everyone)
  for(const [dr, dc] of [[-1,-1],[-1,1],[1,-1],[1,1]]) {
    const mr = r + dr, mc = c + dc;
    const nr = r + dr*2, nc = c + dc*2;
    if(nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
      const mid = board_data[mr][mc];
      if(mid && mid.color !== p.color && !board_data[nr][nc]) {
        moves.push({ row: nr, col: nc, capture: true });
      }
    }
  }
  return moves;
}

function findForcedCaptures() {
  forcedCaptures = [];
  for(let r = 0; r < 8; r++)
    for(let c = 0; c < 8; c++) {
      const p = board_data[r][c];
      if(p && p.color === currentTurn && getValidMoves(r, c).some(m => m.capture))
        forcedCaptures.push({ row: r, col: c });
    }
}

function checkWinCondition() {
  let rc = 0, bc = 0, rm = false, bm = false;
  for(let r = 0; r < 8; r++)
    for(let c = 0; c < 8; c++) {
      const p = board_data[r][c];
      if(p) {
        if(p.color === 'red') { rc++; if(getValidMoves(r,c).length) rm = true; }
        else { bc++; if(getValidMoves(r,c).length) bm = true; }
      }
    }

  if(rc === 0 || (currentTurn === 'red' && !rm)) {
    endGame(myColor === 'black' ? '–ü–æ–±–µ–¥–∞!' : '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!',
            '–ö—Ä–∞—Å–Ω—ã–µ –ø—Ä–æ–∏–≥—Ä–∞–ª–∏', myColor === 'black' ? 'üèÜ' : 'üíÄ');
  } else if(bc === 0 || (currentTurn === 'black' && !bm)) {
    endGame(myColor === 'red' ? '–ü–æ–±–µ–¥–∞!' : '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!',
            '–ß—ë—Ä–Ω—ã–µ –ø—Ä–æ–∏–≥—Ä–∞–ª–∏', myColor === 'red' ? 'üèÜ' : 'üíÄ');
  }
}

function updateTurnUI() {
  const ti = document.getElementById('turnIndicator');
  if(currentTurn === myColor) {
    ti.textContent = 'üî• –í–∞—à —Ö–æ–¥';
    ti.className = 'turn-indicator your-turn';
  } else {
    ti.textContent = '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
    ti.className = 'turn-indicator opponent-turn';
  }
}

function updateScores() {
  let my = 0, opp = 0;
  for(let r = 0; r < 8; r++)
    for(let c = 0; c < 8; c++)
      if(board_data[r][c]) {
        if(board_data[r][c].color === myColor) my++; else opp++;
      }
  document.getElementById('myScore').textContent = '‚¨§ ' + my;
  document.getElementById('oppScore').textContent = '‚¨§ ' + opp;
}

// ===========================
//  UI
// ===========================
function addLog(text, imp = false) {
  const log = document.getElementById('gameLog');
  const e = document.createElement('div');
  e.className = 'log-entry' + (imp ? ' important' : '');
  const t = new Date().toLocaleTimeString('ru', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  e.textContent = `[${t}] ${text}`;
  log.appendChild(e);
  log.scrollTop = log.scrollHeight;
}

function addLogLobby(text) {
  console.log('[LOBBY]', text);
}

function showToast(text) {
  const t = document.getElementById('toast');
  t.textContent = text;
  t.classList.add('show');
  clearTimeout(t._tid);
  t._tid = setTimeout(() => t.classList.remove('show'), 3000);
}

function surrender() {
  if(!gameActive) return;
  if(confirm('–¢–æ—á–Ω–æ —Å–¥–∞—ë—Ç–µ—Å—å?')) {
    if(conn && conn.open) conn.send({ type: 'surrender' });
    endGame('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!', '–í—ã —Å–¥–∞–ª–∏—Å—å', 'üíÄ');
  }
}

function offerDraw() {
  if(!gameActive) return;
  if(conn && conn.open) conn.send({ type: 'offerDraw' });
  showToast('ü§ù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
}

function endGame(title, text, icon) {
  gameActive = false;
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultText').textContent = text;
  document.getElementById('resultIcon').textContent = icon;
  document.getElementById('modalOverlay').classList.add('active');
}

function backToLobby() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.getElementById('gameScreen').style.display = 'none';
  document.getElementById('lobby').classList.remove('hidden');
  document.getElementById('btnCreate').disabled = false;
  document.getElementById('btnCreate').textContent = '‚ö° –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É';
  document.getElementById('btnJoin').disabled = false;
  document.getElementById('roomCodeBox').classList.add('hidden');
  document.getElementById('joinStatus').classList.add('hidden');
  document.getElementById('createError').classList.add('hidden');
  document.getElementById('joinCode').value = '';
  document.getElementById('gameLog').innerHTML = '<h3>üìú –ñ—É—Ä–Ω–∞–ª</h3>';
  if(conn) { try { conn.close(); } catch(e) {} conn = null; }
  if(peer) { try { peer.destroy(); } catch(e) {} peer = null; }
  gameActive = false;
  multiJumpPiece = null;
}

function spawnParticles(row, col) {
  const bEl = document.getElementById('board');
  const rect = bEl.getBoundingClientRect();
  const cs = rect.width / 8;
  const flip = myColor === 'black';
  const dr = flip ? 7 - row : row;
  const dc = flip ? 7 - col : col;
  const cx = rect.left + dc * cs + cs / 2;
  const cy = rect.top + dr * cs + cs / 2;

  for(let i = 0; i < 10; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const s = 3 + Math.random() * 7;
    p.style.width = s + 'px';
    p.style.height = s + 'px';
    p.style.background = `hsl(${Math.random()*40+10},100%,${50+Math.random()*30}%)`;
    p.style.left = cx + 'px';
    p.style.top = cy + 'px';
    const a = Math.random() * Math.PI * 2;
    const d = 30 + Math.random() * 70;
    p.style.setProperty('--dx', Math.cos(a)*d+'px');
    p.style.setProperty('--dy', Math.sin(a)*d+'px');
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1000);
  }
}
</script>
</body>
</html>
