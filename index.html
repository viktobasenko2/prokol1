<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–®–∞—à–∫–∏ ‚Äî –°—Ç–∞—Ä–∏–∫–∞–º —Ç—É—Ç –Ω–µ –º–µ—Å—Ç–æ!</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Russo+One&family=Press+Start+2P&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #0a0a0a;
  color: #e0e0e0;
  font-family: 'Russo One', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* === –§–û–ù–û–í–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø === */
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(255,0,0,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 50%, rgba(255,60,0,0.06) 0%, transparent 50%);
  z-index: -1;
  animation: bgPulse 8s ease-in-out infinite alternate;
}

@keyframes bgPulse {
  0% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* === HEADER === */
.header {
  text-align: center;
  padding: 30px 20px 10px;
  position: relative;
}

.header h1 {
  font-family: 'Press Start 2P', monospace;
  font-size: clamp(18px, 4vw, 36px);
  color: #ff2200;
  text-shadow:
    0 0 10px rgba(255,34,0,0.8),
    0 0 40px rgba(255,34,0,0.4),
    0 0 80px rgba(255,34,0,0.2);
  letter-spacing: 2px;
  animation: titleGlow 3s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  0% { text-shadow: 0 0 10px rgba(255,34,0,0.8), 0 0 40px rgba(255,34,0,0.4); }
  100% { text-shadow: 0 0 20px rgba(255,34,0,1), 0 0 60px rgba(255,34,0,0.6), 0 0 100px rgba(255,34,0,0.3); }
}

.header .subtitle {
  font-size: 14px;
  color: #666;
  margin-top: 8px;
  font-style: italic;
}

/* === –≠–ö–†–ê–ù –õ–û–ë–ë–ò === */
.lobby {
  max-width: 500px;
  margin: 30px auto;
  padding: 0 20px;
}

.lobby-box {
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 1px solid #333;
  border-radius: 16px;
  padding: 30px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.lobby-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, #ff2200, transparent);
}

.lobby-box h2 {
  font-size: 20px;
  color: #ff4444;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.lobby-box h2 .icon {
  font-size: 28px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 28px;
  font-family: 'Russo One', sans-serif;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
  position: relative;
  overflow: hidden;
}

.btn-primary {
  background: linear-gradient(135deg, #ff2200, #cc1100);
  color: white;
  box-shadow: 0 4px 20px rgba(255,34,0,0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 30px rgba(255,34,0,0.5);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background: linear-gradient(135deg, #333, #222);
  color: #ccc;
  border: 1px solid #444;
}

.btn-secondary:hover {
  border-color: #ff4444;
  color: white;
}

.input-group {
  margin-bottom: 15px;
}

.input-group label {
  display: block;
  font-size: 13px;
  color: #888;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.input-group input {
  width: 100%;
  padding: 12px 16px;
  background: #0d0d0d;
  border: 1px solid #333;
  border-radius: 8px;
  color: #fff;
  font-family: 'Russo One', sans-serif;
  font-size: 18px;
  text-align: center;
  letter-spacing: 4px;
  transition: border-color 0.3s;
}

.input-group input:focus {
  outline: none;
  border-color: #ff4444;
  box-shadow: 0 0 15px rgba(255,68,68,0.2);
}

.room-code {
  background: #0d0d0d;
  border: 2px dashed #ff4444;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin: 15px 0;
  cursor: pointer;
  transition: all 0.3s;
}

.room-code:hover {
  background: #1a0a0a;
  border-style: solid;
}

.room-code .code {
  font-family: 'Press Start 2P', monospace;
  font-size: 28px;
  color: #ff4444;
  letter-spacing: 6px;
  text-shadow: 0 0 10px rgba(255,68,68,0.5);
}

.room-code .hint {
  font-size: 11px;
  color: #666;
  margin-top: 8px;
}

.divider {
  text-align: center;
  margin: 25px 0;
  position: relative;
}

.divider::before, .divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: 40%;
  height: 1px;
  background: #333;
}

.divider::before { left: 0; }
.divider::after { right: 0; }

.divider span {
  background: #151515;
  padding: 0 15px;
  color: #555;
  font-size: 13px;
}

.status-bar {
  text-align: center;
  padding: 12px;
  background: rgba(255,34,0,0.1);
  border: 1px solid rgba(255,34,0,0.2);
  border-radius: 8px;
  margin-top: 15px;
  font-size: 14px;
  color: #ff6644;
  animation: statusPulse 2s ease-in-out infinite;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* === –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù === */
.game-screen {
  display: none;
  max-width: 700px;
  margin: 20px auto;
  padding: 0 15px;
}

.game-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding: 15px 20px;
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 1px solid #333;
  border-radius: 12px;
}

.player-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.player-info .piece-preview {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid #555;
}

.player-info .piece-preview.red {
  background: radial-gradient(circle at 35% 35%, #ff6644, #cc2200);
  border-color: #ff4444;
}

.player-info .piece-preview.black {
  background: radial-gradient(circle at 35% 35%, #555, #111);
  border-color: #777;
}

.player-info .name {
  font-size: 14px;
}

.player-info .score {
  font-size: 12px;
  color: #888;
}

.turn-indicator {
  text-align: center;
  font-size: 13px;
  padding: 6px 16px;
  border-radius: 20px;
  font-weight: bold;
}

.turn-indicator.your-turn {
  background: rgba(255,34,0,0.2);
  color: #ff4444;
  border: 1px solid rgba(255,34,0,0.3);
  animation: turnPulse 1.5s ease-in-out infinite;
}

.turn-indicator.opponent-turn {
  background: rgba(255,255,255,0.05);
  color: #666;
  border: 1px solid #333;
}

@keyframes turnPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255,34,0,0.3); }
  50% { box-shadow: 0 0 0 8px rgba(255,34,0,0); }
}

/* === –î–û–°–ö–ê === */
.board-container {
  display: flex;
  justify-content: center;
  margin-bottom: 15px;
}

.board {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 0;
  border: 3px solid #444;
  border-radius: 8px;
  overflow: hidden;
  box-shadow:
    0 0 30px rgba(0,0,0,0.8),
    0 0 60px rgba(255,34,0,0.1);
  width: min(85vw, 560px);
  height: min(85vw, 560px);
}

.cell {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  cursor: default;
  transition: background 0.2s;
}

.cell.light {
  background: #d4a574;
}

.cell.dark {
  background: #8b5e3c;
}

.cell.dark.highlight {
  background: rgba(255,200,0,0.4);
  cursor: pointer;
}

.cell.dark.highlight::after {
  content: '';
  position: absolute;
  width: 30%;
  height: 30%;
  border-radius: 50%;
  background: rgba(255,200,0,0.6);
  animation: dotPulse 1s ease-in-out infinite;
}

.cell.dark.capture-highlight {
  background: rgba(255,0,0,0.35);
  cursor: pointer;
}

.cell.dark.capture-highlight::after {
  content: '';
  position: absolute;
  width: 36%;
  height: 36%;
  border-radius: 50%;
  background: rgba(255,0,0,0.6);
  animation: dotPulse 0.8s ease-in-out infinite;
}

@keyframes dotPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.6; }
}

/* === –®–ê–®–ö–ò === */
.piece {
  width: 78%;
  height: 78%;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  z-index: 2;
}

.piece.red {
  background: radial-gradient(circle at 35% 35%, #ff8866, #dd3311, #991100);
  border: 2px solid #ff6644;
  box-shadow:
    0 3px 8px rgba(0,0,0,0.5),
    inset 0 2px 4px rgba(255,255,255,0.2);
}

.piece.black-piece {
  background: radial-gradient(circle at 35% 35%, #666, #333, #111);
  border: 2px solid #888;
  box-shadow:
    0 3px 8px rgba(0,0,0,0.5),
    inset 0 2px 4px rgba(255,255,255,0.1);
}

.piece:hover {
  transform: scale(1.08);
  filter: brightness(1.2);
}

.piece.selected {
  transform: scale(1.12);
  animation: selectedPulse 1s ease-in-out infinite;
}

.piece.selected.red {
  box-shadow:
    0 0 0 3px rgba(255,68,68,0.5),
    0 0 20px rgba(255,34,0,0.5);
}

.piece.selected.black-piece {
  box-shadow:
    0 0 0 3px rgba(150,150,150,0.5),
    0 0 20px rgba(150,150,150,0.3);
}

@keyframes selectedPulse {
  0%, 100% { filter: brightness(1.2); }
  50% { filter: brightness(1.4); }
}

/* –î–∞–º–∫–∞ */
.piece.king::after {
  content: '‚ôõ';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(16px, 4vw, 28px);
  color: gold;
  text-shadow: 0 0 8px rgba(255,215,0,0.8);
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8));
}

/* === –õ–û–ì === */
.game-log {
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 1px solid #333;
  border-radius: 12px;
  padding: 15px;
  max-height: 150px;
  overflow-y: auto;
  margin-bottom: 15px;
}

.game-log h3 {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.game-log .log-entry {
  font-size: 12px;
  color: #888;
  padding: 3px 0;
  border-bottom: 1px solid #1a1a1a;
}

.game-log .log-entry.important {
  color: #ff4444;
  font-weight: bold;
}

/* === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û === */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.85);
  z-index: 100;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: linear-gradient(145deg, #1a1a1a, #111);
  border: 2px solid #ff4444;
  border-radius: 20px;
  padding: 40px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  animation: modalAppear 0.4s ease;
}

@keyframes modalAppear {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal .result-icon {
  font-size: 64px;
  margin-bottom: 15px;
}

.modal h2 {
  font-family: 'Press Start 2P', monospace;
  font-size: 22px;
  color: #ff4444;
  margin-bottom: 10px;
}

.modal p {
  color: #999;
  margin-bottom: 25px;
}

.game-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
}

.game-actions .btn {
  width: auto;
  padding: 10px 20px;
  font-size: 13px;
}

/* === –°–ö–†–û–õ–õ–ë–ê–† === */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #111; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

/* –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —à–∞—à–∫–∏ */
@keyframes pieceCaptured {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.5; }
  100% { transform: scale(0); opacity: 0; }
}

.piece.captured {
  animation: pieceCaptured 0.4s ease forwards;
  pointer-events: none;
}

.hidden { display: none !important; }

/* Toast */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #222;
  color: #fff;
  padding: 12px 24px;
  border-radius: 8px;
  border: 1px solid #ff4444;
  font-family: 'Russo One', sans-serif;
  font-size: 14px;
  z-index: 200;
  transition: transform 0.3s ease;
  pointer-events: none;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
}

/* Particles */
.particle {
  position: fixed;
  pointer-events: none;
  z-index: 300;
  border-radius: 50%;
  animation: particleFly 1s ease-out forwards;
}

@keyframes particleFly {
  0% { opacity: 1; transform: translate(0,0) scale(1); }
  100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0); }
}
</style>
</head>
<body>

<div class="header">
  <h1>üéØ –°–¢–ê–†–ò–ö–ê–ú –¢–£–¢ –ù–ï –ú–ï–°–¢–û</h1>
  <p class="subtitle">–û–Ω–ª–∞–π–Ω —à–∞—à–∫–∏ ‚Äî P2P –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</p>
</div>

<!-- === –õ–û–ë–ë–ò === -->
<div class="lobby" id="lobby">
  <div class="lobby-box">
    <h2><span class="icon">üî•</span> –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</h2>
    <p style="color:#888; font-size:13px; margin-bottom:15px;">
      –°–æ–∑–¥–∞–π –∫–æ–º–Ω–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –¥—Ä—É–≥—É
    </p>
    <button class="btn btn-primary" id="btnCreate" onclick="createRoom()">
      ‚ö° –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
    </button>
    <div id="roomCodeBox" class="hidden">
      <div class="room-code" onclick="copyCode()">
        <div class="code" id="myRoomCode">---</div>
        <div class="hint">üìã –ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</div>
      </div>
      <div class="status-bar" id="waitStatus">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>
    </div>
  </div>

  <div class="divider"><span>–ò–õ–ò</span></div>

  <div class="lobby-box">
    <h2><span class="icon">üéÆ</span> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h2>
    <div class="input-group">
      <label>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</label>
      <input type="text" id="joinCode" placeholder="–í–í–ï–î–ò –ö–û–î" maxlength="20"
             oninput="this.value=this.value.toUpperCase()">
    </div>
    <button class="btn btn-primary" onclick="joinRoom()">
      üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
    </button>
    <div id="joinStatus" class="hidden">
      <div class="status-bar">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
    </div>
  </div>
</div>

<!-- === –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù === -->
<div class="game-screen" id="gameScreen">
  <div class="game-info">
    <div class="player-info">
      <div class="piece-preview" id="myColorPreview"></div>
      <div>
        <div class="name" id="myLabel">–í—ã</div>
        <div class="score" id="myScore">–®–∞—à–µ–∫: 12</div>
      </div>
    </div>
    <div class="turn-indicator" id="turnIndicator">–í–∞—à —Ö–æ–¥</div>
    <div class="player-info">
      <div>
        <div class="name" id="oppLabel">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
        <div class="score" id="oppScore">–®–∞—à–µ–∫: 12</div>
      </div>
      <div class="piece-preview" id="oppColorPreview"></div>
    </div>
  </div>

  <div class="board-container">
    <div class="board" id="board"></div>
  </div>

  <div class="game-log" id="gameLog">
    <h3>üìú –ñ—É—Ä–Ω–∞–ª –∏–≥—Ä—ã</h3>
  </div>

  <div class="game-actions">
    <button class="btn btn-secondary" onclick="surrender()">üè≥Ô∏è –°–¥–∞—Ç—å—Å—è</button>
    <button class="btn btn-secondary" onclick="offerDraw()">ü§ù –ù–∏—á—å—è</button>
  </div>
</div>

<!-- === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û === -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="result-icon" id="resultIcon">üèÜ</div>
    <h2 id="resultTitle">–ü–æ–±–µ–¥–∞!</h2>
    <p id="resultText">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–∞—Ä—Ç–∏—é</p>
    <button class="btn btn-primary" onclick="backToLobby()" style="width:auto; padding:12px 30px;">
      üîÑ –í –ª–æ–±–±–∏
    </button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===========================
//  –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ===========================
let peer = null;
let conn = null;
let myColor = null;     // 'red' or 'black'
let board = [];         // 8x8: null | {color, king}
let selectedCell = null;
let validMoves = [];
let currentTurn = 'red'; // –∫—Ä–∞—Å–Ω—ã–µ —Ö–æ–¥—è—Ç –ø–µ—Ä–≤—ã–º–∏
let isHost = false;
let gameActive = false;
let forcedCaptures = [];  // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤–∑—è—Ç–∏—è
let multiJumpPiece = null; // —à–∞—à–∫–∞ –¥–µ–ª–∞—é—â–∞—è —Å–µ—Ä–∏—é –≤–∑—è—Ç–∏–π

// ===========================
//  PEER JS SETUP
// ===========================
function generateId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = 'SHSH-';
  for(let i = 0; i < 6; i++) id += chars[Math.floor(Math.random() * chars.length)];
  return id;
}

function createRoom() {
  const roomId = generateId();
  document.getElementById('btnCreate').disabled = true;
  document.getElementById('btnCreate').textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';

  peer = new Peer(roomId, {
    debug: 0
  });

  peer.on('open', (id) => {
    document.getElementById('myRoomCode').textContent = id;
    document.getElementById('roomCodeBox').classList.remove('hidden');
    document.getElementById('btnCreate').textContent = '‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞';
    isHost = true;
    myColor = 'red';
  });

  peer.on('connection', (connection) => {
    conn = connection;
    setupConnection();
    document.getElementById('waitStatus').textContent = '‚úÖ –°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!';
    setTimeout(() => {
      conn.send({ type: 'start', color: 'black' });
      startGame();
    }, 500);
  });

  peer.on('error', (err) => {
    console.error('Peer error:', err);
    showToast('‚ùå –û—à–∏–±–∫–∞: ' + err.type);
    document.getElementById('btnCreate').disabled = false;
    document.getElementById('btnCreate').textContent = '‚ö° –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É';
  });
}

function joinRoom() {
  const code = document.getElementById('joinCode').value.trim();
  if(!code) {
    showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
    return;
  }

  document.getElementById('joinStatus').classList.remove('hidden');

  peer = new Peer(undefined, { debug: 0 });

  peer.on('open', () => {
    conn = peer.connect(code, { reliable: true });

    conn.on('open', () => {
      setupConnection();
    });

    conn.on('error', (err) => {
      showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è');
      console.error(err);
    });
  });

  peer.on('error', (err) => {
    showToast('‚ùå –û—à–∏–±–∫–∞: ' + err.type);
    document.getElementById('joinStatus').classList.add('hidden');
  });
}

function setupConnection() {
  conn.on('data', (data) => {
    handleMessage(data);
  });

  conn.on('close', () => {
    if(gameActive) {
      showToast('‚ö†Ô∏è –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
      endGame('–°–æ–ø–µ—Ä–Ω–∏–∫ —Å–±–µ–∂–∞–ª!', '–ü–æ–±–µ–¥–∞ –∑–∞ –≤–∞–º–∏ ‚Äî —Å–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è', 'üèÉ');
    }
  });
}

function handleMessage(data) {
  switch(data.type) {
    case 'start':
      myColor = data.color;
      startGame();
      break;
    case 'move':
      executeMove(data.from, data.to, false);
      break;
    case 'surrender':
      endGame('–ü–æ–±–µ–¥–∞!', '–°–æ–ø–µ—Ä–Ω–∏–∫ —Å–¥–∞–ª—Å—è üè≥Ô∏è', 'üèÜ');
      break;
    case 'offerDraw':
      if(confirm('–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∏—á—å—é. –ü—Ä–∏–Ω—è—Ç—å?')) {
        conn.send({ type: 'acceptDraw' });
        endGame('–ù–∏—á—å—è!', '–ò–≥—Ä–æ–∫–∏ —Å–æ–≥–ª–∞—Å–∏–ª–∏—Å—å –Ω–∞ –Ω–∏—á—å—é', 'ü§ù');
      } else {
        conn.send({ type: 'declineDraw' });
      }
      break;
    case 'acceptDraw':
      endGame('–ù–∏—á—å—è!', '–°–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–∏–Ω—è–ª –Ω–∏—á—å—é', 'ü§ù');
      break;
    case 'declineDraw':
      showToast('‚ùå –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª –Ω–∏—á—å—é');
      break;
  }
}

function copyCode() {
  const code = document.getElementById('myRoomCode').textContent;
  navigator.clipboard.writeText(code).then(() => {
    showToast('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
  }).catch(() => {
    // fallback
    const ta = document.createElement('textarea');
    ta.value = code;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
  });
}

// ===========================
//  –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
// ===========================
function initBoard() {
  board = [];
  for(let r = 0; r < 8; r++) {
    board[r] = [];
    for(let c = 0; c < 8; c++) {
      board[r][c] = null;
      if((r + c) % 2 === 1) {
        if(r < 3) {
          board[r][c] = { color: 'black', king: false };
        } else if(r > 4) {
          board[r][c] = { color: 'red', king: false };
        }
      }
    }
  }
  currentTurn = 'red';
  selectedCell = null;
  validMoves = [];
  multiJumpPiece = null;
  forcedCaptures = [];
}

function startGame() {
  gameActive = true;
  initBoard();
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('gameScreen').style.display = 'block';

  // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ–¥ —Ü–≤–µ—Ç
  const myPrev = document.getElementById('myColorPreview');
  const oppPrev = document.getElementById('oppColorPreview');
  myPrev.className = 'piece-preview ' + myColor;
  oppPrev.className = 'piece-preview ' + (myColor === 'red' ? 'black' : 'red');
  document.getElementById('myLabel').textContent = '–í—ã (' + (myColor === 'red' ? 'üî¥' : '‚ö´') + ')';
  document.getElementById('oppLabel').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ (' + (myColor === 'red' ? '‚ö´' : 'üî¥') + ')';

  addLog('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –ö—Ä–∞—Å–Ω—ã–µ —Ö–æ–¥—è—Ç –ø–µ—Ä–≤—ã–º–∏.');
  if(myColor === 'red') {
    addLog('–í–∞—à —Ö–æ–¥!', true);
  }

  renderBoard();
  updateTurnUI();
}

function renderBoard() {
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';

  // –ï—Å–ª–∏ –º—ã —á—ë—Ä–Ω—ã–µ ‚Äî –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–æ—Å–∫—É
  const flip = (myColor === 'black');

  for(let ri = 0; ri < 8; ri++) {
    for(let ci = 0; ci < 8; ci++) {
      const r = flip ? 7 - ri : ri;
      const c = flip ? 7 - ci : ci;

      const cell = document.createElement('div');
      const isDark = (r + c) % 2 === 1;
      cell.className = 'cell ' + (isDark ? 'dark' : 'light');
      cell.dataset.row = r;
      cell.dataset.col = c;

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ö–æ–¥–æ–≤
      if(isDark) {
        const moveInfo = validMoves.find(m => m.row === r && m.col === c);
        if(moveInfo) {
          if(moveInfo.capture) {
            cell.classList.add('capture-highlight');
          } else {
            cell.classList.add('highlight');
          }
          cell.addEventListener('click', () => onMoveClick(r, c));
        }
      }

      // –®–∞—à–∫–∞
      const piece = board[r][c];
      if(piece) {
        const pieceEl = document.createElement('div');
        pieceEl.className = 'piece ' + (piece.color === 'red' ? 'red' : 'black-piece');
        if(piece.king) pieceEl.classList.add('king');

        // –í—ã–¥–µ–ª–µ–Ω–∞ –ª–∏
        if(selectedCell && selectedCell.row === r && selectedCell.col === c) {
          pieceEl.classList.add('selected');
        }

        // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –ª–∏ (—Å–≤–æ—è + —Å–≤–æ–π —Ö–æ–¥)
        if(piece.color === myColor && currentTurn === myColor && gameActive) {
          pieceEl.style.cursor = 'pointer';
          pieceEl.addEventListener('click', (e) => {
            e.stopPropagation();
            onPieceClick(r, c);
          });
        }

        cell.appendChild(pieceEl);
      }

      boardEl.appendChild(cell);
    }
  }

  updateScores();
}

function onPieceClick(r, c) {
  if(currentTurn !== myColor || !gameActive) return;

  // –ü—Ä–∏ —Å–µ—Ä–∏–∏ –≤–∑—è—Ç–∏–π ‚Äî –Ω–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —à–∞—à–∫—É
  if(multiJumpPiece && (multiJumpPiece.row !== r || multiJumpPiece.col !== c)) {
    showToast('‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–µ—Ä–∏—é –≤–∑—è—Ç–∏–π!');
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤–∑—è—Ç–∏—è
  findForcedCaptures();

  if(forcedCaptures.length > 0) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–∑—è—Ç–∏–µ —É —ç—Ç–æ–π —à–∞—à–∫–∏
    const hasCap = forcedCaptures.some(fc => fc.row === r && fc.col === c);
    if(!hasCap) {
      showToast('‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –≤–∑—è—Ç–∏–µ!');
      return;
    }
  }

  selectedCell = { row: r, col: c };
  validMoves = getValidMoves(r, c);

  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤–∑—è—Ç–∏—è ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∑—è—Ç–∏—è
  if(forcedCaptures.length > 0) {
    validMoves = validMoves.filter(m => m.capture);
  }

  renderBoard();
}

function onMoveClick(r, c) {
  if(!selectedCell) return;
  const moveInfo = validMoves.find(m => m.row === r && m.col === c);
  if(!moveInfo) return;

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫—É
  conn.send({ type: 'move', from: { row: selectedCell.row, col: selectedCell.col }, to: { row: r, col: c } });

  executeMove(selectedCell, { row: r, col: c }, true);
}

function executeMove(from, to, isMyMove) {
  const piece = board[from.row][from.col];
  if(!piece) return;

  const moveInfo = getMoveDetails(from.row, from.col, to.row, to.col, piece);

  // –î–≤–∏–≥–∞–µ–º —à–∞—à–∫—É
  board[to.row][to.col] = piece;
  board[from.row][from.col] = null;

  // –í–∑—è—Ç–∏–µ
  let captured = false;
  if(moveInfo.capture) {
    board[moveInfo.capturedRow][moveInfo.capturedCol] = null;
    captured = true;

    const capColor = piece.color === 'red' ? '‚ö´' : 'üî¥';
    addLog(`${piece.color === 'red' ? 'üî¥' : '‚ö´'} –±—å—ë—Ç ${capColor}!`, true);

    // –°–ø–∞–≤–Ω–∏–º —á–∞—Å—Ç–∏—Ü—ã
    spawnParticles(to.row, to.col);
  }

  // –î–∞–º–∫–∞
  if(piece.color === 'red' && to.row === 0 && !piece.king) {
    piece.king = true;
    addLog('üî¥ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–º–∫—É! üëë', true);
  }
  if(piece.color === 'black' && to.row === 7 && !piece.king) {
    piece.king = true;
    addLog('‚ö´ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–º–∫—É! üëë', true);
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–∏—é –≤–∑—è—Ç–∏–π
  if(captured) {
    const nextCaptures = getValidMoves(to.row, to.col).filter(m => m.capture);
    if(nextCaptures.length > 0 && !piece.king || (piece.king && nextCaptures.length > 0)) {
      // –ú–æ–∂–Ω–æ –µ—â—ë –±–∏—Ç—å ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ö–æ–¥
      multiJumpPiece = { row: to.row, col: to.col };
      selectedCell = { row: to.row, col: to.col };
      validMoves = nextCaptures;
      renderBoard();

      if(!isMyMove) {
        // –°–æ–ø–µ—Ä–Ω–∏–∫ –µ—â—ë –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª —Ö–æ–¥ ‚Äî –∂–¥—ë–º
      }
      return;
    }
  }

  // –•–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω
  multiJumpPiece = null;
  selectedCell = null;
  validMoves = [];
  forcedCaptures = [];

  // –ü–µ—Ä–µ–¥–∞—ë–º —Ö–æ–¥
  currentTurn = (currentTurn === 'red') ? 'black' : 'red';

  renderBoard();
  updateTurnUI();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
  checkWinCondition();
}

function getMoveDetails(fromR, fromC, toR, toC, piece) {
  const dr = toR - fromR;
  const dc = toC - fromC;

  if(Math.abs(dr) === 2 && Math.abs(dc) === 2) {
    const capturedRow = fromR + dr / 2;
    const capturedCol = fromC + dc / 2;
    return { capture: true, capturedRow, capturedCol };
  }

  return { capture: false };
}

function getValidMoves(r, c) {
  const piece = board[r][c];
  if(!piece) return [];

  const moves = [];
  const dirs = [];

  if(piece.king) {
    dirs.push([-1, -1], [-1, 1], [1, -1], [1, 1]);
  } else if(piece.color === 'red') {
    dirs.push([-1, -1], [-1, 1]); // –≤–≤–µ—Ä—Ö
    // –í–∑—è—Ç–∏—è –º–æ–∂–Ω–æ –∏ –Ω–∞–∑–∞–¥
  } else {
    dirs.push([1, -1], [1, 1]); // –≤–Ω–∏–∑
  }

  // –û–±—ã—á–Ω—ã–µ —Ö–æ–¥—ã
  for(const [dr, dc] of dirs) {
    const nr = r + dr;
    const nc = c + dc;
    if(nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && board[nr][nc] === null) {
      moves.push({ row: nr, col: nc, capture: false });
    }
  }

  // –í–∑—è—Ç–∏—è (–≤—Å–µ 4 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —à–∞—à–µ–∫)
  const capDirs = [[-1, -1], [-1, 1], [1, -1], [1, 1]];
  for(const [dr, dc] of capDirs) {
    const mr = r + dr;
    const mc = c + dc;
    const nr = r + dr * 2;
    const nc = c + dc * 2;
    if(nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
      const mid = board[mr][mc];
      if(mid && mid.color !== piece.color && board[nr][nc] === null) {
        moves.push({ row: nr, col: nc, capture: true, capturedRow: mr, capturedCol: mc });
      }
    }
  }

  return moves;
}

function findForcedCaptures() {
  forcedCaptures = [];
  for(let r = 0; r < 8; r++) {
    for(let c = 0; c < 8; c++) {
      const p = board[r][c];
      if(p && p.color === currentTurn) {
        const moves = getValidMoves(r, c);
        if(moves.some(m => m.capture)) {
          forcedCaptures.push({ row: r, col: c });
        }
      }
    }
  }
}

function checkWinCondition() {
  let redCount = 0, blackCount = 0;
  let redMoves = false, blackMoves = false;

  for(let r = 0; r < 8; r++) {
    for(let c = 0; c < 8; c++) {
      const p = board[r][c];
      if(p) {
        if(p.color === 'red') {
          redCount++;
          if(getValidMoves(r, c).length > 0) redMoves = true;
        } else {
          blackCount++;
          if(getValidMoves(r, c).length > 0) blackMoves = true;
        }
      }
    }
  }

  if(redCount === 0 || (!redMoves && currentTurn === 'red')) {
    const iWin = myColor === 'black';
    endGame(iWin ? '–ü–æ–±–µ–¥–∞!' : '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!',
            iWin ? '–£ –∫—Ä–∞—Å–Ω—ã—Ö –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤' : '–£ –≤–∞—Å –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤',
            iWin ? 'üèÜ' : 'üíÄ');
  } else if(blackCount === 0 || (!blackMoves && currentTurn === 'black')) {
    const iWin = myColor === 'red';
    endGame(iWin ? '–ü–æ–±–µ–¥–∞!' : '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!',
            iWin ? '–£ —á—ë—Ä–Ω—ã—Ö –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤' : '–£ –≤–∞—Å –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤',
            iWin ? 'üèÜ' : 'üíÄ');
  }
}

function updateTurnUI() {
  const ti = document.getElementById('turnIndicator');
  if(currentTurn === myColor) {
    ti.textContent = 'üî• –í–∞—à —Ö–æ–¥';
    ti.className = 'turn-indicator your-turn';
  } else {
    ti.textContent = '‚è≥ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
    ti.className = 'turn-indicator opponent-turn';
  }
}

function updateScores() {
  let myCount = 0, oppCount = 0;
  const oppColor = myColor === 'red' ? 'black' : 'red';
  for(let r = 0; r < 8; r++) {
    for(let c = 0; c < 8; c++) {
      if(board[r][c]) {
        if(board[r][c].color === myColor) myCount++;
        else oppCount++;
      }
    }
  }
  document.getElementById('myScore').textContent = '–®–∞—à–µ–∫: ' + myCount;
  document.getElementById('oppScore').textContent = '–®–∞—à–µ–∫: ' + oppCount;
}

// ===========================
//  UI –§–£–ù–ö–¶–ò–ò
// ===========================
function addLog(text, important = false) {
  const log = document.getElementById('gameLog');
  const entry = document.createElement('div');
  entry.className = 'log-entry' + (important ? ' important' : '');
  const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  entry.textContent = `[${time}] ${text}`;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
}

function showToast(text) {
  const toast = document.getElementById('toast');
  toast.textContent = text;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

function surrender() {
  if(!gameActive) return;
  if(confirm('–¢–æ—á–Ω–æ —Å–¥–∞—ë—Ç–µ—Å—å? –≠—Ç–æ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ!')) {
    conn.send({ type: 'surrender' });
    endGame('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!', '–í—ã —Å–¥–∞–ª–∏—Å—å üè≥Ô∏è', 'üíÄ');
  }
}

function offerDraw() {
  if(!gameActive) return;
  conn.send({ type: 'offerDraw' });
  showToast('ü§ù –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∏—á—å–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
}

function endGame(title, text, icon) {
  gameActive = false;
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultText').textContent = text;
  document.getElementById('resultIcon').textContent = icon;
  document.getElementById('modalOverlay').classList.add('active');
}

function backToLobby() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.getElementById('gameScreen').style.display = 'none';
  document.getElementById('lobby').classList.remove('hidden');
  document.getElementById('btnCreate').disabled = false;
  document.getElementById('btnCreate').textContent = '‚ö° –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É';
  document.getElementById('roomCodeBox').classList.add('hidden');
  document.getElementById('joinStatus').classList.add('hidden');
  document.getElementById('joinCode').value = '';
  document.getElementById('gameLog').innerHTML = '<h3>üìú –ñ—É—Ä–Ω–∞–ª –∏–≥—Ä—ã</h3>';

  if(conn) { conn.close(); conn = null; }
  if(peer) { peer.destroy(); peer = null; }

  gameActive = false;
  multiJumpPiece = null;
}

function spawnParticles(row, col) {
  const boardEl = document.getElementById('board');
  const rect = boardEl.getBoundingClientRect();
  const cellSize = rect.width / 8;
  const flip = (myColor === 'black');
  const dr = flip ? 7 - row : row;
  const dc = flip ? 7 - col : col;
  const cx = rect.left + dc * cellSize + cellSize / 2;
  const cy = rect.top + dr * cellSize + cellSize / 2;

  for(let i = 0; i < 12; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 4 + Math.random() * 8;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.background = `hsl(${Math.random() * 40 + 10}, 100%, ${50 + Math.random() * 30}%)`;
    p.style.left = cx + 'px';
    p.style.top = cy + 'px';
    const angle = Math.random() * Math.PI * 2;
    const dist = 40 + Math.random() * 80;
    p.style.setProperty('--dx', Math.cos(angle) * dist + 'px');
    p.style.setProperty('--dy', Math.sin(angle) * dist + 'px');
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1000);
  }
}
</script>

</body>
</html>
